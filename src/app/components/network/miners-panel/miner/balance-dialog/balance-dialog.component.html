<div
  class="fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center z-50 backdrop-blur"
  (click)="onBackdropClick($event)"
>
  <div
    class="bg-zinc-800 rounded-lg shadow-lg pt-6 min-w-[320px] max-w-[90vw] w-full max-h-[95vh] h-full flex flex-col"
  >
    <button
      class="absolute top-2 right-2 text-zinc-400 hover:text-red-400"
      (click)="onClose()"
      title="Fechar"
    >
      <i class="pi pi-times text-lg"></i>
    </button>
    <h2 class="text-lg font-bold text-blue-400 mb-4 px-6">
      Endereços, Saldos e UTXOs
    </h2>
    <div class="px-6 mb-2 text-sm text-blue-200/80">
      <span class="font-semibold">Dica:</span> Veja abaixo a relação entre
      chaves, endereços e saldos.
      <span class="text-green-300"
        >Apenas endereços pertencentes a esse nó exibem as chaves
        correspondentes</span
      >.
    </div>

    <div class="mb-4 flex flex-col md:flex-row gap-2 md:items-center px-6">
      <p-selectButton
        [options]="displayModeOptions"
        [(ngModel)]="displayMode"
        (onChange)="onDisplayModeChange()"
        optionLabel="label"
        optionValue="value"
        class="w-full md:w-auto"
      ></p-selectButton>
      <p-selectButton
        [options]="keyFormatOptions"
        [(ngModel)]="keyFormat"
        optionLabel="label"
        optionValue="value"
        class="w-full md:w-auto"
      ></p-selectButton>
    </div>

    <div class="flex-1 flex flex-col min-h-0">
      <div class="flex-1 min-h-0 flex flex-col">
        <p-table
          [value]="
            displayMode === 'with-balance'
              ? addresses.slice(first, first + rows)
              : addresses
          "
          dataKey="address"
          [style]="{ 'font-size': '0.95rem', width: '100%', height: '100%' }"
          [scrollable]="true"
          [scrollHeight]="'100%'"
          rowExpandMode="multiple"
          [rowTrackBy]="rowTrackBy"
          class="rounded-lg flex-1 h-full w-full"
        >
          <ng-template pTemplate="header">
            <tr class="text-white font-bold text-base">
              <th class="text-left p-4"></th>
              <th
                class="text-left p-4"
                title="A chave privada permite gastar os bitcoins deste endereço. Só você deve conhecê-la."
              >
                Chave Privada
              </th>
              <th
                class="text-left p-4"
                title="A chave pública é derivada da chave privada e usada para gerar o endereço."
              >
                Chave Pública
              </th>
              <th
                class="text-left p-4"
                title="O endereço é gerado a partir da chave pública. Pode ser compartilhado para receber bitcoins."
              >
                Endereço
              </th>
              <th
                class="text-right p-4"
                [ngClass]="
                  displayMode === 'with-balance' ? 'cursor-pointer group' : ''
                "
                (click)="
                  displayMode === 'with-balance' ? onSort('saldo') : null
                "
                [attr.title]="
                  displayMode === 'with-balance' ? 'Clique para ordenar' : null
                "
              >
                Saldo <span class="text-white/70">(BTC)</span>
                <ng-container *ngIf="displayMode === 'with-balance'">
                  <span>
                    <i
                      class="pi"
                      [ngClass]="
                        sortField === 'saldo'
                          ? sortOrder === 1
                            ? 'pi-sort-amount-up-alt'
                            : 'pi-sort-amount-down'
                          : 'pi-sort-amount-up-alt'
                      "
                      [style.opacity]="sortField === 'saldo' ? '1' : '0.4'"
                      style="font-size: 0.9em; margin-left: 0.5em"
                    ></i>
                  </span>
                  <button
                    (click)="$event.stopPropagation(); clearSort()"
                    class="ml-1 text-zinc-400 hover:text-red-400"
                    title="Limpar ordenação"
                    style="
                      background: none;
                      border: none;
                      cursor: pointer;
                      width: 1.5em;
                      height: 1.5em;
                      padding: 0;
                    "
                    [style.visibility]="
                      sortField === 'saldo' ? 'visible' : 'hidden'
                    "
                  >
                    <i class="pi pi-times"></i>
                  </button>
                </ng-container>
              </th>
              <th class="text-right p-4">Qtd UTXOs</th>
            </tr>
          </ng-template>
          <ng-template
            pTemplate="body"
            let-entry
            let-expanded="expanded"
            let-rowIndex="rowIndex"
          >
            <tr>
              <td class="p-4 align-middle">
                <button
                  *ngIf="entry.utxos && entry.utxos.length > 0"
                  pButton
                  type="button"
                  [icon]="
                    expanded ? 'pi pi-chevron-down' : 'pi pi-chevron-right'
                  "
                  (click)="$event.stopPropagation(); entry.expanded = !expanded"
                  pRowToggler
                  [pRowToggler]="entry"
                  class="p-button-text p-0 text-white/70 hover:text-white focus:ring-0 focus:outline-none"
                  style="height: 1.7rem; width: 1.7rem"
                  [attr.aria-label]="expanded ? 'Colapsar' : 'Expandir'"
                ></button>
              </td>
              <td
                class="font-mono p-4 text-green-400 align-middle"
                style="max-width: 220px; word-break: break-all"
              >
                <ng-container
                  *ngIf="entry.keys && entry.keys.priv; else unknownPriv"
                >
                  {{ getPrivKeyDisplay(entry.keys) }}
                </ng-container>
                <ng-template #unknownPriv>
                  <span title="Chave privada não conhecida (endereço externo)">
                    <i class="pi pi-lock text-zinc-500"></i>
                  </span>
                </ng-template>
              </td>
              <td
                class="font-mono p-4 text-blue-400 align-middle"
                style="max-width: 220px; word-break: break-all"
              >
                <ng-container
                  *ngIf="entry.keys && entry.keys.pub; else unknownPub"
                >
                  {{ getPubKeyDisplay(entry.keys) }}
                </ng-container>
                <ng-template #unknownPub>
                  <span title="Chave pública não conhecida (endereço externo)">
                    <i class="pi pi-lock text-zinc-500"></i>
                  </span>
                </ng-template>
              </td>
              <td
                class="font-mono p-4 align-middle"
                style="max-width: 320px; word-break: break-all"
              >
                <ng-container
                  *ngIf="displayMode === 'with-balance'; else allAddresses"
                >
                  <span *ngIf="entry.legacy.address">{{
                    entry.legacy.address
                  }}</span>
                  <span *ngIf="entry.p2sh.address">{{
                    entry.p2sh.address
                  }}</span>
                  <span *ngIf="entry.bech32.address">{{
                    entry.bech32.address
                  }}</span>
                </ng-container>
                <ng-template #allAddresses>
                  <div>
                    <span style="color: #b3b3b3; font-weight: 500"
                      >Legacy:</span
                    >
                    {{ entry.legacy.address }}
                  </div>
                  <div>
                    <span style="color: #8ca0b3; font-weight: 500">P2SH:</span>
                    {{ entry.p2sh.address }}
                  </div>
                  <div>
                    <span style="color: #b39ddb; font-weight: 500"
                      >Bech32:</span
                    >
                    {{ entry.bech32.address }}
                  </div>
                </ng-template>
              </td>
              <td class="text-right p-4 align-middle" style="min-width: 120px">
                <ng-container
                  *ngIf="displayMode === 'with-balance'; else allSaldos"
                >
                  <span *ngIf="entry.legacy.balance">{{
                    entry.legacy.balance / 100000000 | number : "1.8-8"
                  }}</span>
                  <span *ngIf="entry.p2sh.balance">{{
                    entry.p2sh.balance / 100000000 | number : "1.8-8"
                  }}</span>
                  <span *ngIf="entry.bech32.balance">{{
                    entry.bech32.balance / 100000000 | number : "1.8-8"
                  }}</span>
                  <span
                    style="
                      display: inline-block;
                      width: 1.5em;
                      height: 1.5em;
                      vertical-align: middle;
                    "
                  ></span>
                </ng-container>
                <ng-template #allSaldos>
                  <div>
                    <span style="color: #b3b3b3; font-weight: 500">{{
                      entry.legacy.balance / 100000000 | number : "1.8-8"
                    }}</span>
                    <span
                      style="
                        display: inline-block;
                        width: 1.5em;
                        height: 1.5em;
                        vertical-align: middle;
                      "
                    ></span>
                  </div>
                  <div>
                    <span style="color: #8ca0b3; font-weight: 500">{{
                      entry.p2sh.balance / 100000000 | number : "1.8-8"
                    }}</span>
                    <span
                      style="
                        display: inline-block;
                        width: 1.5em;
                        height: 1.5em;
                        vertical-align: middle;
                      "
                    ></span>
                  </div>
                  <div>
                    <span style="color: #b39ddb; font-weight: 500">{{
                      entry.bech32.balance / 100000000 | number : "1.8-8"
                    }}</span>
                    <span
                      style="
                        display: inline-block;
                        width: 1.5em;
                        height: 1.5em;
                        vertical-align: middle;
                      "
                    ></span>
                  </div>
                </ng-template>
              </td>
              <td class="text-right p-4 align-middle" style="min-width: 80px">
                <ng-container
                  *ngIf="displayMode === 'with-balance'; else allUtxos"
                >
                  <span *ngIf="entry.legacy.utxos.length">{{
                    entry.legacy.utxos.length
                  }}</span>
                  <span *ngIf="entry.p2sh.utxos.length">{{
                    entry.p2sh.utxos.length
                  }}</span>
                  <span *ngIf="entry.bech32.utxos.length">{{
                    entry.bech32.utxos.length
                  }}</span>
                </ng-container>
                <ng-template #allUtxos>
                  <div>
                    <span style="color: #b3b3b3; font-weight: 500">{{
                      entry.legacy.utxos.length
                    }}</span>
                  </div>
                  <div>
                    <span style="color: #8ca0b3; font-weight: 500">{{
                      entry.p2sh.utxos.length
                    }}</span>
                  </div>
                  <div>
                    <span style="color: #b39ddb; font-weight: 500">{{
                      entry.bech32.utxos.length
                    }}</span>
                  </div>
                </ng-template>
              </td>
            </tr>
          </ng-template>
          <ng-template pTemplate="rowexpansion" let-entry>
            <tr>
              <td colspan="6" class="py-8">
                <h3 class="text-white/80 font-bold text-sm">UTXOs</h3>
                <p-table
                  [value]="entry.utxos"
                  [tableStyle]="{ 'min-width': '100%' }"
                  [style]="{ 'font-size': '0.95rem' }"
                >
                  <ng-template pTemplate="header">
                    <tr class="text-white/80 font-bold text-sm">
                      <th class="text-left px-4 py-3">TxID</th>
                      <th class="text-right px-4 py-3">Out</th>
                      <th class="text-right px-4 py-3">Valor</th>
                    </tr>
                  </ng-template>
                  <ng-template pTemplate="body" let-utxo>
                    <tr>
                      <td
                        class="font-mono text-xs text-white/80 px-4 py-3"
                        [title]="utxo.txId"
                        style="
                          max-width: 120px;
                          overflow: hidden;
                          text-overflow: ellipsis;
                          white-space: nowrap;
                        "
                      >
                        {{ utxo.txId | slice : 0 : 8 }}…
                      </td>
                      <td class="text-right text-white/60 px-4 py-3">
                        {{ utxo.outputIndex }}
                      </td>
                      <td class="text-right px-4 py-3">
                        <span class="text-white font-mono">{{
                          utxo.output.value / 100000000 | number : "1.8-8"
                        }}</span>
                        <span class="text-white/40">BTC</span>
                      </td>
                    </tr>
                  </ng-template>
                  <ng-template pTemplate="emptymessage">
                    <tr>
                      <td colspan="3" class="text-white/60 italic py-3 px-4">
                        Nenhum UTXO disponível.
                      </td>
                    </tr>
                  </ng-template>
                </p-table>
              </td>
            </tr>
          </ng-template>
        </p-table>
      </div>
      <div
        *ngIf="totalPagesDisplay > 1"
        class="flex flex-col md:flex-row md:items-center justify-between gap-4 px-6 py-4 bg-zinc-900 rounded-b-lg border-t border-zinc-700 mt-2"
      >
        <!-- Indicador de página atual -->
        <div
          class="flex flex-1 items-center justify-start gap-2 text-white/80 text-sm font-mono"
        >
          <span class="text-zinc-400">Página</span>
          <span class="font-bold text-blue-300">#{{ currentPageDisplay }}</span>
          <span class="text-zinc-400">of</span>
          <span class="font-bold text-blue-300">{{ totalPagesDisplay }}</span>
          <span class="text-zinc-500"
            >({{ pagePercent | number : "1.0-2" }}%)</span
          >
        </div>

        <!-- Botões de navegação -->
        <div class="flex flex-1 items-center justify-center gap-1">
          <button
            pButton
            icon="pi pi-angle-double-left"
            class="p-button-sm p-button-rounded p-button-text text-zinc-400 hover:text-blue-400"
            (click)="goToFirstPage()"
            [disabled]="prevDisabled"
            [ngClass]="{ 'opacity-50': prevDisabled }"
            title="Primeira página"
          ></button>
          <button
            pButton
            icon="pi pi-angle-left"
            class="p-button-sm p-button-rounded p-button-text text-zinc-400 hover:text-blue-400"
            (click)="goToPreviousPage()"
            [disabled]="prevDisabled"
            [ngClass]="{ 'opacity-50': prevDisabled }"
            title="Página anterior"
          ></button>
          <button
            pButton
            icon="pi pi-refresh"
            class="p-button-sm p-button-rounded p-button-text text-zinc-400 hover:text-blue-400"
            (click)="goToRandomPage()"
            title="Página aleatória"
          ></button>
          <button
            pButton
            icon="pi pi-angle-right"
            class="p-button-sm p-button-rounded p-button-text text-zinc-400 hover:text-blue-400"
            (click)="goToNextPage()"
            [disabled]="nextDisabled"
            [ngClass]="{ 'opacity-50': nextDisabled }"
            title="Próxima página"
          ></button>
          <button
            pButton
            icon="pi pi-angle-double-right"
            class="p-button-sm p-button-rounded p-button-text text-zinc-400 hover:text-blue-400"
            (click)="goToLastPage()"
            [disabled]="nextDisabled"
            [ngClass]="{ 'opacity-50': nextDisabled }"
            title="Última página"
          ></button>
        </div>

        <!-- Input para pular para página -->
        <form
          class="flex flex-1 items-center justify-end gap-2"
          (submit)="jumpToPage(); $event.preventDefault()"
          autocomplete="off"
        >
          <input
            type="text"
            [(ngModel)]="jumpPageInput"
            name="jumpPageInput"
            placeholder="Página #"
            class="flex-1 bg-zinc-800 border border-zinc-700 rounded px-2 py-1 text-sm text-white font-mono w-24 focus:outline-none focus:border-blue-400"
            style="min-width: 120px"
          />
          <button
            pButton
            type="submit"
            icon="pi pi-arrow-right"
            class="p-button-sm p-button-rounded p-button-text text-blue-400"
            label="Ir para"
            style="min-width: 60px"
          ></button>
        </form>
      </div>
    </div>
  </div>
</div>
