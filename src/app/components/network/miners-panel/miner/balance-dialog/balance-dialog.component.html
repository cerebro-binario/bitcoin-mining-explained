<div
  class="fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center z-50 backdrop-blur"
  (click)="onBackdropClick($event)"
>
  <div
    class="bg-zinc-800 rounded-lg shadow-lg p-6 min-w-[320px] max-w-[90vw] w-full max-h-[80vh] overflow-y-auto relative h-full"
  >
    <button
      class="absolute top-2 right-2 text-zinc-400 hover:text-red-400"
      (click)="onClose()"
      title="Fechar"
    >
      <i class="pi pi-times text-lg"></i>
    </button>
    <h2 class="text-lg font-bold text-blue-400 mb-4">
      Endereços, Saldos e UTXOs
    </h2>

    <div class="mb-4">
      <p-selectButton
        [options]="displayModeOptions"
        [(ngModel)]="displayMode"
        (onChange)="onDisplayModeChange()"
        optionLabel="label"
        optionValue="value"
        class="w-full"
      ></p-selectButton>
    </div>

    <div class="overflow-x-auto">
      <p-table
        [value]="addresses.slice(first, first + rows)"
        dataKey="address"
        [tableStyle]="{ 'min-width': '600px' }"
        [style]="{ 'font-size': '0.95rem' }"
        [scrollable]="true"
        rowExpandMode="multiple"
        [rowTrackBy]="rowTrackBy"
        class="rounded-lg shadow"
      >
        <ng-template pTemplate="header">
          <tr class="text-white font-bold text-base">
            <th class="text-left p-4"></th>
            <th class="text-left p-4">Endereço</th>
            <th class="text-right p-4">
              Saldo <span class="text-white/70">(BTC)</span>
            </th>
            <th class="text-right p-4">Qtd UTXOs</th>
          </tr>
        </ng-template>
        <ng-template
          pTemplate="body"
          let-entry
          let-expanded="expanded"
          let-rowIndex="rowIndex"
        >
          <tr>
            <td class="p-4 align-middle">
              <button
                pButton
                type="button"
                [icon]="expanded ? 'pi pi-chevron-down' : 'pi pi-chevron-right'"
                (click)="$event.stopPropagation(); entry.expanded = !expanded"
                pRowToggler
                [pRowToggler]="entry"
                class="p-button-text p-0 text-white/70 hover:text-white focus:ring-0 focus:outline-none"
                style="height: 1.7rem; width: 1.7rem"
                [disabled]="!entry.utxos || entry.utxos.length === 0"
                [attr.aria-label]="expanded ? 'Colapsar' : 'Expandir'"
              ></button>
            </td>
            <td class="font-mono p-4 text-white/90 align-middle">
              <span class="text-white/40 text-xs">{{
                entry.nodeName || "(Desconhecido)"
              }}</span>
              {{ entry.address }}
            </td>
            <td class="text-right p-4 align-middle">
              <span class="text-white font-mono">{{
                entry.balance / 100000000 | number : "1.8-8"
              }}</span>
            </td>
            <td class="text-right p-4 align-middle text-white/80">
              {{ entry.utxos.length }}
            </td>
          </tr>
        </ng-template>
        <ng-template pTemplate="rowexpansion" let-entry>
          <tr>
            <td colspan="4" class="py-8">
              <h3 class="text-white/80 font-bold text-sm">UTXOs</h3>
              <p-table
                [value]="entry.utxos"
                [tableStyle]="{ 'min-width': '100%' }"
                [style]="{ 'font-size': '0.95rem' }"
              >
                <ng-template pTemplate="header">
                  <tr class="text-white/80 font-bold text-sm">
                    <th class="text-left px-4 py-3">TxID</th>
                    <th class="text-right px-4 py-3">Out</th>
                    <th class="text-right px-4 py-3">Valor</th>
                  </tr>
                </ng-template>
                <ng-template pTemplate="body" let-utxo>
                  <tr>
                    <td
                      class="font-mono text-xs text-white/80 px-4 py-3"
                      [title]="utxo.txId"
                      style="
                        max-width: 120px;
                        overflow: hidden;
                        text-overflow: ellipsis;
                        white-space: nowrap;
                      "
                    >
                      {{ utxo.txId | slice : 0 : 8 }}…
                    </td>
                    <td class="text-right text-white/60 px-4 py-3">
                      {{ utxo.outputIndex }}
                    </td>
                    <td class="text-right px-4 py-3">
                      <span class="text-white font-mono">{{
                        utxo.output.value / 100000000 | number : "1.8-8"
                      }}</span>
                      <span class="text-white/40">BTC</span>
                    </td>
                  </tr>
                </ng-template>
                <ng-template pTemplate="emptymessage">
                  <tr>
                    <td colspan="3" class="text-white/60 italic py-3 px-4">
                      Nenhum UTXO disponível.
                    </td>
                  </tr>
                </ng-template>
              </p-table>
            </td>
          </tr>
        </ng-template>
      </p-table>

      <p-paginator
        [rows]="rows"
        [totalRecords]="totalRecords"
        [first]="first"
        [rowsPerPageOptions]="[10, 20, 50]"
        (onPageChange)="onPageChange($event)"
        class="mt-4"
      ></p-paginator>
    </div>
  </div>
</div>
