<div
  *ngIf="miner"
  class="bg-zinc-800 rounded-lg shadow p-6 border border-zinc-700 space-y-4 h-full"
  [ngClass]="miner.isMaximized ? 'pt-0' : ''"
>
  <div
    class="flex items-center gap-2"
    [ngClass]="
      miner.isMaximized
        ? 'sticky top-0 z-20 bg-zinc-800 border-b border-zinc-700 py-6'
        : ''
    "
  >
    <span class="text-lg font-bold text-blue-400 flex items-center gap-2">
      {{ miner.name }}
      <span class="text-xs text-zinc-400 ml-2" title="Versão do Consenso">
        v{{ miner.consensus.version }}
      </span>
      <div class="flex items-center gap-2">
        <span
          class="inline-block w-3 h-3 rounded-full border border-zinc-700"
          [ngClass]="{
            'bg-green-500': statusColor === 'green',
            'bg-blue-500': statusColor === 'blue',
            'bg-red-500': statusColor === 'red'
          }"
          [title]="
            statusColor === 'red'
              ? 'Desconectado da rede'
              : statusColor === 'blue'
              ? 'Sincronizando com peers'
              : 'Conectado'
          "
        ></span>
        <span
          class="text-xs text-zinc-400 cursor-pointer hover:underline"
          title="Peers Conectados"
          (click)="openPeersDialog()"
        >
          {{ miner.peers.length }} peers
          <button
            class="ml-1 p-1 rounded-full transition align-middle relative overflow-hidden"
            (click)="connectToPeers(); $event.stopPropagation()"
            [disabled]="miner.isSearchingPeers"
            [title]="
              miner.isSearchingPeers
                ? 'Procurando conexões...'
                : 'Procurar conexões na rede'
            "
            [ngClass]="{
              'animate-spin': miner.isSearchingPeers,
              'bg-blue-700/30': miner.isSearchingPeers,
              'hover:bg-blue-700/30': !miner.isSearchingPeers
            }"
            style="vertical-align: middle"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              class="w-4 h-4 text-blue-400 transition-transform"
              [ngClass]="{
                'animate-spin': miner.isSearchingPeers
              }"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
              stroke-width="2"
            >
              <circle cx="12" cy="12" r="4" />
              <path d="M2 12a10 10 0 0 1 20 0" />
              <path d="M12 2v2m0 16v2m10-10h-2M4 12H2" />
            </svg>
            <span
              *ngIf="miner.isSearchingPeers"
              class="absolute inset-0 rounded-full border-2 border-blue-400 opacity-40 animate-pulse"
            ></span>
          </button>
        </span>
      </div>
    </span>

    <!-- Mining Controls in Header -->
    <ng-container *ngIf="miner">
      <span
        class="ml-2 px-3 py-1 rounded text-xs font-semibold flex items-center justify-center min-w-[110px] transition-colors"
        [ngClass]="{
          'bg-green-900 text-green-400': miner.isMining,
          'bg-zinc-900 text-zinc-400': !miner.isMining
        }"
        [title]="miner.isMining ? 'Minerando' : 'Parado'"
      >
        <ng-container *ngIf="miner.isMining">
          <svg
            class="inline h-3 w-3 mr-1"
            fill="currentColor"
            viewBox="0 0 20 20"
          >
            <path d="M6 4h2v12H6V4zm6 0h2v12h-2V4z" />
          </svg>
          Minerando
        </ng-container>
        <ng-container *ngIf="!miner.isMining">
          <svg
            class="inline h-3 w-3 mr-1"
            fill="currentColor"
            viewBox="0 0 20 20"
          >
            <circle cx="10" cy="10" r="5" />
          </svg>
          Parado
        </ng-container>
      </span>
      <button
        *ngIf="!miner.isMining"
        class="ml-4 px-3 py-1 rounded bg-green-600 hover:bg-green-700 text-white text-sm font-semibold transition"
        (click)="startMining()"
      >
        Iniciar Mineração
      </button>
      <button
        *ngIf="miner.isMining"
        class="ml-4 px-3 py-1 rounded bg-yellow-600 text-white text-sm font-semibold hover:bg-yellow-700 transition"
        (click)="stopMining()"
      >
        Pausar Mineração
      </button>
      <button
        class="ml-2 px-3 py-1 rounded bg-blue-600 text-white text-sm font-semibold hover:bg-blue-700 transition"
        (click)="createTransaction()"
      >
        Nova Transação
      </button>
    </ng-container>

    <!-- Chain Info -->
    <div class="flex items-center gap-2 ml-4">
      <span class="text-xs text-zinc-400">Chain:</span>
      <span class="text-xs text-blue-400">{{
        miner.heights.length > 0 ? miner.heights.length - 1 : 0
      }}</span>
      <span class="text-xs text-zinc-400">blocos</span>
      <span *ngIf="miner.getLatestBlock()" class="text-xs text-blue-400"
        >(#{{ miner.getLatestBlock()?.height }})</span
      >
    </div>

    <!-- Miner ID -->
    <span class="ml-auto text-xs text-zinc-400">#{{ miner.id }}</span>
    <button
      class="ml-2 p-1.5 rounded text-zinc-400 hover:text-yellow-400 hover:bg-zinc-700 transition flex items-center justify-center"
      (click)="showAddressesDialog = true"
      title="Ver todos os endereços e UTXOs"
    >
      <i class="pi pi-wallet text-xs"></i>
    </button>
    <button
      class="ml-2 p-1.5 rounded text-zinc-400 hover:text-blue-400 hover:bg-zinc-700 transition flex items-center justify-center"
      (click)="editConsensusParams()"
      title="Parâmetros de Consenso"
    >
      <i class="pi pi-cog text-xs"></i>
    </button>

    <!-- Collapse Button -->
    <button
      *ngIf="!miner.isMaximized"
      class="ml-2 p-1.5 rounded text-zinc-400 hover:text-blue-400 hover:bg-zinc-700 transition flex items-center justify-center"
      (click)="setOrToggleCollapsed()"
      [title]="miner.isCollapsed ? 'Expandir minerador' : 'Recolher minerador'"
    >
      <i
        class="pi pi-chevron-up text-xs"
        [ngClass]="{ 'rotate-180': !miner.isCollapsed }"
      ></i>
    </button>

    <!-- Remove Miner Button -->
    <button
      *ngIf="!miner.isMaximized"
      class="ml-2 p-1.5 rounded text-zinc-400 hover:text-red-400 hover:bg-zinc-700 transition flex items-center justify-center"
      (click)="confirmRemoveMiner()"
      pButton
      pRipple
      title="Remover minerador"
    >
      <i class="pi pi-trash text-xs"></i>
    </button>

    <p-confirmDialog></p-confirmDialog>

    <!-- Maximize Miner Button -->
    <button
      *ngIf="!miner.isMaximized"
      class="ml-2 p-1.5 rounded text-zinc-400 hover:text-blue-400 hover:bg-zinc-700 transition flex items-center justify-center"
      (click)="setOrToggleMaximized(true)"
      title="Visualizar minerador em tela cheia"
    >
      <i class="pi pi-external-link text-xs"></i>
    </button>

    <!-- Minimize Miner Button -->
    <button
      *ngIf="miner.isMaximized"
      class="ml-2 p-1.5 rounded text-zinc-400 hover:text-blue-400 hover:bg-zinc-700 transition flex items-center justify-center"
      (click)="setOrToggleMaximized(false)"
      title="Minimizar minerador"
    >
      <i class="pi pi-window-minimize text-xs"></i>
    </button>
  </div>

  <!-- Mini-chain dos últimos 5 blocos -->
  <div
    *ngIf="miner.isCollapsed"
    class="flex items-center gap-2 px-4 py-2 min-h-8"
  >
    <app-mini-blockchain [node]="miner"></app-mini-blockchain>
    <span *ngIf="miner.lastMainBlocks.length > 0" class="text-zinc-500">→</span>
    <div
      class="flex flex-col items-center justify-center w-8 h-8 rounded-md border-2 border-dashed text-[0.85rem]"
      [ngClass]="{
        'border-green-400 bg-green-900/30 text-green-300': miner.isMining,
        'border-zinc-500 bg-zinc-800/40 text-zinc-400 opacity-60':
          !miner.isMining
      }"
      [title]="
        miner.isMining
          ? 'Bloco atual em mineração\nHeight: ' +
            (miner.currentBlock?.height ?? '-') +
            '\nNonce: ' +
            (miner.currentBlock?.nonce ?? '-') +
            '\nTxs: ' +
            (miner.currentBlock?.transactions?.length ?? 0)
          : 'Nenhum bloco sendo minerado'
      "
    >
      <svg
        *ngIf="miner.isMining"
        class="w-3 h-3 mb-0.5"
        fill="none"
        stroke="currentColor"
        stroke-width="2"
        viewBox="0 0 20 20"
      >
        <path
          stroke-linecap="round"
          stroke-linejoin="round"
          d="M13 10V3L4 14h7v7l9-11h-7z"
        />
      </svg>
      <span *ngIf="miner.isMining">{{
        miner.currentBlock?.height ?? "..."
      }}</span>
      <span *ngIf="!miner.isMining">...</span>
    </div>
    <span class="mx-2 text-zinc-600">|</span>
    <span
      class="flex items-center gap-1 text-xs font-mono group relative"
      [ngClass]="miner.isMining ? 'text-green-400' : 'text-zinc-400'"
      [title]="'Hash rate real'"
    >
      <svg
        class="w-4 h-4"
        fill="none"
        stroke="currentColor"
        stroke-width="2"
        viewBox="0 0 20 20"
      >
        <path
          stroke-linecap="round"
          stroke-linejoin="round"
          d="M4 13h1v-2H4v2zm3 0h1v-6H7v6zm3 0h1V7h-1v6zm3 0h1v-4h-1v4z"
        />
      </svg>
      {{ miner.currentHashRate | number : "1.0-0" }} H/s
      <button
        class="ml-1 p-0.5 rounded hover:bg-zinc-700 transition hidden group-hover:inline-block align-middle"
        (click)="
          $event.stopPropagation();
          isCollapsedHashRateSelectorOpen = !isCollapsedHashRateSelectorOpen
        "
        tabindex="-1"
        [title]="'Alterar Hash Rate'"
      >
        <svg
          class="w-3.5 h-3.5 text-zinc-400"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
          viewBox="0 0 20 20"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            d="M15.232 5.232l-10 10M16.5 7.5l-4-4a2.121 2.121 0 00-3 3l4 4a2.121 2.121 0 003-3z"
          />
        </svg>
      </button>
      <div
        *ngIf="isCollapsedHashRateSelectorOpen"
        class="absolute z-20 top-6 left-0 bg-zinc-800 border border-zinc-700 rounded shadow p-1 flex flex-col min-w-[6rem]"
      >
        <button
          *ngFor="let rate of hashRateOptions"
          class="px-2 py-1 text-xs rounded text-left hover:bg-blue-700/30 transition"
          [ngClass]="{
            'bg-blue-700/40 text-blue-300 font-bold':
              miner.hashRate === rate.value,
            'text-zinc-200': miner.hashRate !== rate.value
          }"
          (click)="
            setHashRate(rate.value); isCollapsedHashRateSelectorOpen = false
          "
        >
          {{ rate.label }}
        </button>
      </div>
    </span>
  </div>

  <div
    class="transition-all duration-300 ease-in-out"
    [ngStyle]="{
      'max-height': miner.isCollapsed ? '0px' : null,
      opacity: miner.isCollapsed ? '0' : '1',
      overflow: miner.isCollapsed ? 'hidden' : 'visible'
    }"
  >
    <div class="space-y-5">
      <div class="flex items-center gap-2">
        <span class="text-xs text-zinc-400">Endereço:</span>
        <span class="font-mono text-xs text-green-400 break-all">{{
          miner.miningAddress
        }}</span>
      </div>
      <div class="flex items-center gap-2">
        <span class="text-xs text-zinc-400">Saldo:</span>
        <span class="font-mono text-xs text-green-400">
          {{ balance / 100000000 | number : "1.8-8" }} BTC
        </span>
      </div>
      <div class="flex items-center gap-2">
        <span class="text-xs text-zinc-400">UTXOs:</span>
        <span class="font-mono text-xs text-green-400">
          {{ utxos.length }} outputs não gastos
        </span>
      </div>
      <div class="flex items-center gap-2">
        <span class="text-xs text-zinc-400">Assinatura:</span>
        <span class="font-mono text-xs text-green-400">{{ miner.name }}</span>
      </div>

      <!-- Hash Rate Minimalista (agora realmente fora do header) -->
      <div class="flex items-center gap-2">
        <span class="text-xs text-zinc-400">Hash Rate:</span>
        <div class="flex justify-between items-center gap-1">
          <ng-container *ngFor="let rate of hashRateOptions">
            <button
              class="px-2 py-1 rounded border text-xs font-semibold transition min-w-[3.5rem]"
              [ngClass]="{
                'border-blue-500 bg-blue-600/10 text-blue-400 font-bold':
                  miner.hashRate === rate.value,
                'border-zinc-600 bg-transparent text-zinc-300 hover:border-blue-400 hover:text-blue-300':
                  miner.hashRate !== rate.value
              }"
              (click)="setHashRate(rate.value)"
              [title]="rate.label"
            >
              {{ rate.label }}
            </button>
          </ng-container>
        </div>
        <span *ngIf="miner.isMining" class="text-xs text-green-400 ml-2">
          (Real: {{ miner.currentHashRate | number }} H/s)
        </span>
      </div>
    </div>

    <div class="flex flex-col md:flex-row gap-6 mt-6 h-[390px] relative">
      <app-mining-block
        class="w-full h-full"
        [block]="miner.currentBlock"
        [miningElapsed]="miner.currentBlock?.miningElapsed"
      ></app-mining-block>
      <app-events
        [node]="miner"
        class="h-full"
        (show)="showLogs()"
        (close)="closeLogs()"
      ></app-events>
    </div>

    <!-- Blockchain Local -->
    <div class="mt-6">
      <div
        class="flex items-center justify-between mb-4 cursor-pointer hover:bg-zinc-700/50 p-2 rounded transition-colors"
        (click)="toggleBlockchainVisibility()"
      >
        <div class="flex items-center gap-2">
          <h3 class="text-lg font-semibold text-blue-400">Blockchain Local</h3>
          <span class="text-xs text-zinc-400">
            {{ miner.heights.length > 0 ? miner.heights.length - 1 : 0 }} blocos
            <span *ngIf="miner.getLatestBlock()"
              >(Último: #{{ miner.getLatestBlock()?.height }})</span
            >
          </span>
        </div>
        <div class="flex items-center gap-2">
          <span class="text-xs text-zinc-400">{{
            isBlockchainVisible ? "Recolher" : "Expandir"
          }}</span>
          <svg
            xmlns="http://www.w3.org/2000/svg"
            class="h-5 w-5 text-zinc-400 transition-transform"
            [ngClass]="{ 'rotate-180': isBlockchainVisible }"
            fill="none"
            viewBox="0 0 24 24"
            stroke="currentColor"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M19 9l-7 7-7-7"
            />
          </svg>
        </div>
      </div>
      <div
        class="relative transition-all duration-300 ease-in-out w-[calc(100%+theme('spacing.6')*2)] -left-6"
        [ngStyle]="{
          'max-height': !isBlockchainVisible ? '0px' : null,
          opacity: isBlockchainVisible ? '1' : '0',
          overflow: isBlockchainVisible ? 'visible' : 'hidden',
        }"
      >
        <app-blockchain [node]="miner"></app-blockchain>
      </div>
    </div>
  </div>
</div>

<app-consensus-dialog
  *ngIf="showConsensusDialog"
  [miner]="miner"
  (close)="onConsensusDialogClose()"
  (versionChange)="onConsensusVersionChange()"
></app-consensus-dialog>

<!-- Peers Dialog -->
<app-peers-dialog
  *ngIf="showPeersDialog"
  [miner]="miner"
  (close)="closePeersDialog()"
></app-peers-dialog>

<!-- Dialog de endereços, saldos e UTXOs -->
<ng-template [ngIf]="showAddressesDialog">
  <div
    class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50"
  >
    <div class="bg-zinc-800 rounded-lg shadow-lg p-6 w-full max-w-2xl relative">
      <button
        class="absolute top-2 right-2 text-zinc-400 hover:text-red-400"
        (click)="showAddressesDialog = false"
        title="Fechar"
      >
        <svg
          class="w-5 h-5"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M6 18L18 6M6 6l12 12"
          />
        </svg>
      </button>
      <h2 class="text-lg font-bold text-blue-400 mb-4">
        Endereços, Saldos e UTXOs
      </h2>
      <div class="overflow-x-auto max-h-[60vh]">
        <table class="min-w-full text-xs">
          <thead>
            <tr class="text-zinc-400 border-b border-zinc-700">
              <th class="text-left p-2">Endereço</th>
              <th class="text-right p-2">Saldo (BTC)</th>
              <th class="text-right p-2">Qtd UTXOs</th>
              <th class="text-left p-2">UTXOs</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let entry of getAllAddresses()">
              <td class="font-mono p-2">{{ entry.address }}</td>
              <td class="text-right p-2">
                {{ entry.balance / 100000000 | number : "1.8-8" }}
              </td>
              <td class="text-right p-2">{{ entry.utxos.length }}</td>
              <td class="p-2">
                <div *ngFor="let utxo of entry.utxos" class="mb-1">
                  <span class="font-mono text-xs text-zinc-300">
                    Tx: {{ utxo.txId }}, Out: {{ utxo.outputIndex }}, Valor:
                    {{ utxo.output.value / 100000000 | number : "1.8-8" }} BTC
                  </span>
                </div>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>
</ng-template>
