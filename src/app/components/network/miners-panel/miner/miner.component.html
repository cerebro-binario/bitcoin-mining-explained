<div
  *ngIf="miner"
  class="bg-zinc-800 rounded-lg shadow p-6 border border-zinc-700 space-y-4 h-full"
  [ngClass]="miner.isMaximized ? 'pt-0' : ''"
>
  <div
    class="flex items-center gap-2"
    [ngClass]="
      miner.isMaximized
        ? 'sticky top-0 z-20 bg-zinc-800 border-b border-zinc-700 py-6'
        : ''
    "
  >
    <span class="text-lg font-bold text-blue-400 flex items-center gap-2">
      {{ miner.name }}
      <span class="text-xs text-zinc-400 ml-2" title="Versão do Consenso">
        v{{ miner.consensus.version }}
      </span>
      <span
        class="inline-block w-3 h-3 rounded-full border border-zinc-700"
        [ngClass]="{
          'bg-blue-500 animate-pulse': miner.isSyncing,
          'bg-green-500': !miner.isSyncing
        }"
        [title]="miner.isSyncing ? 'Sincronizando com peers' : 'Conectado'"
      ></span>
      <span class="text-xs text-zinc-400 ml-2" title="Peers Conectados">
        {{ miner.neighbors.length }} peers
      </span>
    </span>

    <!-- Mining Controls in Header -->
    <ng-container *ngIf="miner">
      <span
        class="ml-2 px-3 py-1 rounded text-xs font-semibold flex items-center justify-center min-w-[110px] transition-colors"
        [ngClass]="{
          'bg-green-900 text-green-400': miner.isMining,
          'bg-zinc-900 text-zinc-400': !miner.isMining
        }"
        [title]="miner.isMining ? 'Minerando' : 'Parado'"
      >
        <ng-container *ngIf="miner.isMining">
          <svg
            class="inline h-3 w-3 mr-1"
            fill="currentColor"
            viewBox="0 0 20 20"
          >
            <path d="M6 4h2v12H6V4zm6 0h2v12h-2V4z" />
          </svg>
          Minerando
        </ng-container>
        <ng-container *ngIf="!miner.isMining">
          <svg
            class="inline h-3 w-3 mr-1"
            fill="currentColor"
            viewBox="0 0 20 20"
          >
            <circle cx="10" cy="10" r="5" />
          </svg>
          Parado
        </ng-container>
      </span>
      <button
        *ngIf="!miner.isMining"
        class="ml-4 px-3 py-1 rounded text-white text-sm font-semibold transition"
        [ngClass]="{
          'bg-green-600 hover:bg-green-700':
            !miner.isSyncing || miner.initialSyncComplete,
          'bg-zinc-600 cursor-not-allowed':
            miner.isSyncing && !miner.initialSyncComplete
        }"
        (click)="startMining()"
        [disabled]="miner.isSyncing && !miner.initialSyncComplete"
        [title]="
          miner.isSyncing && !miner.initialSyncComplete
            ? 'Aguarde o download inicial da blockchain'
            : ''
        "
      >
        {{
          miner.isSyncing && !miner.initialSyncComplete
            ? "Aguardando Sincronização"
            : "Iniciar Mineração"
        }}
      </button>
      <button
        *ngIf="miner.isMining"
        class="ml-4 px-3 py-1 rounded bg-yellow-600 text-white text-sm font-semibold hover:bg-yellow-700 transition"
        (click)="stopMining()"
      >
        Pausar Mineração
      </button>
      <button
        class="ml-2 px-3 py-1 rounded bg-blue-600 text-white text-sm font-semibold hover:bg-blue-700 transition"
        (click)="createTransaction()"
      >
        Nova Transação
      </button>
    </ng-container>

    <!-- Chain Info -->
    <div class="flex items-center gap-2 ml-4">
      <span class="text-xs text-zinc-400">Chain:</span>
      <span class="text-xs text-blue-400">{{
        miner.heights.length > 0 ? miner.heights.length - 1 : 0
      }}</span>
      <span class="text-xs text-zinc-400">blocos</span>
      <span *ngIf="miner.getLatestBlock()" class="text-xs text-blue-400"
        >(#{{ miner.getLatestBlock()?.height }})</span
      >
    </div>

    <!-- Connect to Peers Button -->
    <button
      *ngIf="miner.neighbors.length === 0"
      class="ml-4 px-3 py-1 rounded text-white text-sm font-semibold transition bg-blue-600 hover:bg-blue-700"
      (click)="connectToPeers()"
      [disabled]="isConnecting"
      [title]="isConnecting ? 'Conectando...' : 'Conectar a peers aleatórios'"
    >
      {{ isConnecting ? "Conectando..." : "Conectar Peers" }}
    </button>

    <!-- Miner ID -->
    <span class="ml-auto text-xs text-zinc-400">#{{ miner.id }}</span>

    <!-- Consensus Button -->
    <button
      class="ml-2 p-1 rounded text-zinc-400 hover:text-blue-400 hover:bg-zinc-700 transition"
      (click)="editConsensusParams()"
      title="Parâmetros de Consenso"
    >
      <svg
        class="w-4 h-4"
        fill="none"
        stroke="currentColor"
        viewBox="0 0 24 24"
      >
        <path
          stroke-linecap="round"
          stroke-linejoin="round"
          stroke-width="2"
          d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"
        />
        <path
          stroke-linecap="round"
          stroke-linejoin="round"
          stroke-width="2"
          d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"
        />
      </svg>
    </button>

    <!-- Collapse Button -->
    <button
      *ngIf="!miner.isMaximized"
      class="ml-2 p-1 rounded text-zinc-400 hover:text-blue-400 hover:bg-zinc-700 transition"
      (click)="setOrToggleCollapsed()"
      [title]="miner.isCollapsed ? 'Expandir minerador' : 'Recolher minerador'"
    >
      <svg
        xmlns="http://www.w3.org/2000/svg"
        class="h-4 w-4 transition-transform"
        [ngClass]="{ 'rotate-180': !miner.isCollapsed }"
        fill="none"
        viewBox="0 0 24 24"
        stroke="currentColor"
      >
        <path
          stroke-linecap="round"
          stroke-linejoin="round"
          stroke-width="2"
          d="M19 9l-7 7-7-7"
        />
      </svg>
    </button>

    <!-- Remove Miner Button -->
    <button
      *ngIf="!miner.isMaximized"
      class="ml-2 p-1 rounded text-zinc-400 hover:text-red-400 hover:bg-zinc-700 transition"
      (click)="confirmRemoveMiner()"
      pButton
      pRipple
      title="Remover minerador"
    >
      <svg
        xmlns="http://www.w3.org/2000/svg"
        class="h-4 w-4"
        fill="none"
        viewBox="0 0 24 24"
        stroke="currentColor"
      >
        <path
          stroke-linecap="round"
          stroke-linejoin="round"
          stroke-width="2"
          d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"
        />
      </svg>
    </button>

    <p-confirmDialog></p-confirmDialog>

    <!-- Maximize Miner Button -->
    <button
      *ngIf="!miner.isMaximized"
      class="ml-2 p-1 rounded text-zinc-400 hover:text-blue-400 hover:bg-zinc-700 transition"
      (click)="setOrToggleMaximized(true)"
      title="Visualizar minerador em tela cheia"
    >
      <svg
        xmlns="http://www.w3.org/2000/svg"
        class="h-4 w-4"
        fill="none"
        viewBox="0 0 24 24"
        stroke="currentColor"
      >
        <path
          stroke-linecap="round"
          stroke-linejoin="round"
          stroke-width="2"
          d="M4 8V4h4M20 8V4h-4M4 16v4h4m12-4v4h-4"
        />
      </svg>
    </button>

    <!-- Minimize Miner Button -->
    <button
      *ngIf="miner.isMaximized"
      class="ml-2 p-1 rounded text-zinc-400 hover:text-blue-400 hover:bg-zinc-700 transition"
      (click)="setOrToggleMaximized(false)"
      title="Minimizar minerador"
    >
      <svg
        xmlns="http://www.w3.org/2000/svg"
        class="h-4 w-4"
        fill="none"
        viewBox="0 0 24 24"
        stroke="currentColor"
      >
        <path
          stroke-linecap="round"
          stroke-linejoin="round"
          stroke-width="2"
          d="M20 12H4"
        />
      </svg>
    </button>
  </div>

  <!-- Mini-chain dos últimos 5 blocos -->
  <div
    *ngIf="miner.isCollapsed"
    class="flex items-center gap-2 px-4 py-2 min-h-8"
  >
    <ng-container *ngFor="let block of miner.lastMainBlocks; let i = index">
      <div class="relative flex flex-col items-center justify-center">
        <ng-container *ngIf="miner.activeForkHeights.includes(block.height)">
          <div class="absolute bottom-full flex items-center mb-0.5">
            <svg
              class="w-3 h-3 text-yellow-400"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              viewBox="0 0 20 20"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                d="M10 4v4m0 0c0 2.5-3 2.5-3 5m3-5c0 2.5 3 2.5 3 5"
              />
            </svg>
            <span class="text-[0.65em] text-yellow-400 ml-0.5 font-semibold">{{
              block.height
            }}</span>
          </div>
        </ng-container>
        <div
          class="flex flex-col items-center justify-center w-8 h-8 rounded-md border-2 text-[0.85rem] cursor-pointer transition duration-200 ease-in-out"
          [ngClass]="{
            'bg-blue-700 border-blue-400 text-white':
              i === miner.lastMainBlocks.length - 1,
            'bg-zinc-700 border-zinc-500 text-zinc-200':
              i !== miner.lastMainBlocks.length - 1
          }"
          [title]="
            'Bloco #' +
            block.height +
            '\nHash: ' +
            block.hash +
            '\nMiner: ' +
            (block.minerId ?? '-') +
            '\nTxs: ' +
            block.transactions.length +
            (miner.activeForkHeights.includes(block.height)
              ? '\nFork ativo nesta altura'
              : '')
          "
        >
          <span>{{ block.height }}</span>
          <span
            class="text-[0.65em] -mt-0.5"
            [ngClass]="{
              'text-green-400 font-bold': block.minerId === miner.id,
              'text-zinc-300': block.minerId !== miner.id
            }"
            >M{{ block.minerId ?? "-" }}</span
          >
        </div>
      </div>
      <span *ngIf="i < miner.lastMainBlocks.length - 1" class="text-zinc-500"
        >→</span
      >
    </ng-container>
    <span *ngIf="miner.lastMainBlocks.length > 0" class="text-zinc-500">→</span>
    <div
      class="flex flex-col items-center justify-center w-8 h-8 rounded-md border-2 border-dashed text-[0.85rem]"
      [ngClass]="{
        'border-green-400 bg-green-900/30 text-green-300': miner.isMining,
        'border-zinc-500 bg-zinc-800/40 text-zinc-400 opacity-60':
          !miner.isMining
      }"
      [title]="
        miner.isMining
          ? 'Bloco atual em mineração\nHeight: ' +
            (miner.currentBlock?.height ?? '-') +
            '\nNonce: ' +
            (miner.currentBlock?.nonce ?? '-') +
            '\nTxs: ' +
            (miner.currentBlock?.transactions?.length ?? 0)
          : 'Nenhum bloco sendo minerado'
      "
    >
      <svg
        *ngIf="miner.isMining"
        class="w-3 h-3 mb-0.5"
        fill="none"
        stroke="currentColor"
        stroke-width="2"
        viewBox="0 0 20 20"
      >
        <path
          stroke-linecap="round"
          stroke-linejoin="round"
          d="M13 10V3L4 14h7v7l9-11h-7z"
        />
      </svg>
      <span *ngIf="miner.isMining">{{
        miner.currentBlock?.height ?? "..."
      }}</span>
      <span *ngIf="!miner.isMining">...</span>
    </div>
    <span class="mx-2 text-zinc-600">|</span>
    <span
      class="flex items-center gap-1 text-xs font-mono group relative"
      [ngClass]="miner.isMining ? 'text-green-400' : 'text-zinc-400'"
      [title]="'Hash rate real'"
    >
      <svg
        class="w-4 h-4"
        fill="none"
        stroke="currentColor"
        stroke-width="2"
        viewBox="0 0 20 20"
      >
        <path
          stroke-linecap="round"
          stroke-linejoin="round"
          d="M4 13h1v-2H4v2zm3 0h1v-6H7v6zm3 0h1V7h-1v6zm3 0h1v-4h-1v4z"
        />
      </svg>
      {{ miner.currentHashRate | number : "1.0-0" }} H/s
      <button
        class="ml-1 p-0.5 rounded hover:bg-zinc-700 transition hidden group-hover:inline-block align-middle"
        (click)="
          $event.stopPropagation();
          isCollapsedHashRateSelectorOpen = !isCollapsedHashRateSelectorOpen
        "
        tabindex="-1"
        [title]="'Alterar Hash Rate'"
      >
        <svg
          class="w-3.5 h-3.5 text-zinc-400"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
          viewBox="0 0 20 20"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            d="M15.232 5.232l-10 10M16.5 7.5l-4-4a2.121 2.121 0 00-3 3l4 4a2.121 2.121 0 003-3z"
          />
        </svg>
      </button>
      <div
        *ngIf="isCollapsedHashRateSelectorOpen"
        class="absolute z-20 top-6 left-0 bg-zinc-800 border border-zinc-700 rounded shadow p-1 flex flex-col min-w-[6rem]"
      >
        <button
          *ngFor="let rate of hashRateOptions"
          class="px-2 py-1 text-xs rounded text-left hover:bg-blue-700/30 transition"
          [ngClass]="{
            'bg-blue-700/40 text-blue-300 font-bold':
              miner.hashRate === rate.value,
            'text-zinc-200': miner.hashRate !== rate.value
          }"
          (click)="
            setHashRate(rate.value); isCollapsedHashRateSelectorOpen = false
          "
        >
          {{ rate.label }}
        </button>
      </div>
    </span>
  </div>

  <div
    class="transition-all duration-300 ease-in-out"
    [ngStyle]="{
      'max-height': miner.isCollapsed ? '0px' : null,
      opacity: miner.isCollapsed ? '0' : '1',
      overflow: miner.isCollapsed ? 'hidden' : 'visible'
    }"
  >
    <div class="space-y-5">
      <div class="flex items-center gap-2">
        <span class="text-xs text-zinc-400">Endereço:</span>
        <span class="font-mono text-xs text-green-400 break-all">{{
          miner.miningAddress
        }}</span>
      </div>
      <div class="flex items-center gap-2">
        <span class="text-xs text-zinc-400">Assinatura:</span>
        <span class="font-mono text-xs text-green-400">{{ miner.name }}</span>
      </div>

      <!-- Hash Rate Minimalista (agora realmente fora do header) -->
      <div class="flex items-center gap-2">
        <span class="text-xs text-zinc-400">Hash Rate:</span>
        <div class="flex justify-between items-center gap-1">
          <ng-container *ngFor="let rate of hashRateOptions">
            <button
              class="px-2 py-1 rounded border text-xs font-semibold transition min-w-[3.5rem]"
              [ngClass]="{
                'border-blue-500 bg-blue-600/10 text-blue-400 font-bold':
                  miner.hashRate === rate.value,
                'border-zinc-600 bg-transparent text-zinc-300 hover:border-blue-400 hover:text-blue-300':
                  miner.hashRate !== rate.value
              }"
              (click)="setHashRate(rate.value)"
              [title]="rate.label"
            >
              {{ rate.label }}
            </button>
          </ng-container>
        </div>
        <span *ngIf="miner.isMining" class="text-xs text-green-400 ml-2">
          (Real: {{ miner.currentHashRate | number }} H/s)
        </span>
      </div>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-6">
      <app-event-logs
        [node]="miner"
        class="flex"
        (show)="showLogs()"
        (close)="closeLogs()"
      ></app-event-logs>

      <app-mining-block
        [block]="miner.currentBlock"
        [miningElapsed]="miner.currentBlock?.miningElapsed"
      ></app-mining-block>
    </div>

    <!-- Blockchain Local -->
    <div class="mt-6">
      <div
        class="flex items-center justify-between mb-4 cursor-pointer hover:bg-zinc-700/50 p-2 rounded transition-colors"
        (click)="toggleBlockchainVisibility()"
      >
        <div class="flex items-center gap-2">
          <h3 class="text-lg font-semibold text-blue-400">Blockchain Local</h3>
          <span class="text-xs text-zinc-400">
            {{ miner.heights.length > 0 ? miner.heights.length - 1 : 0 }} blocos
            <span *ngIf="miner.getLatestBlock()"
              >(Último: #{{ miner.getLatestBlock()?.height }})</span
            >
          </span>
        </div>
        <div class="flex items-center gap-2">
          <span class="text-xs text-zinc-400">{{
            isBlockchainVisible ? "Recolher" : "Expandir"
          }}</span>
          <svg
            xmlns="http://www.w3.org/2000/svg"
            class="h-5 w-5 text-zinc-400 transition-transform"
            [ngClass]="{ 'rotate-180': isBlockchainVisible }"
            fill="none"
            viewBox="0 0 24 24"
            stroke="currentColor"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M19 9l-7 7-7-7"
            />
          </svg>
        </div>
      </div>
      <div
        class="relative transition-all duration-300 ease-in-out w-[calc(100%+theme('spacing.6')*2)] -left-6"
        [ngStyle]="{
          'max-height': !isBlockchainVisible ? '0px' : null,
          opacity: isBlockchainVisible ? '1' : '0',
          overflow: isBlockchainVisible ? 'visible' : 'hidden',
        }"
      >
        <app-blockchain [miner]="miner"></app-blockchain>
      </div>
    </div>
  </div>
</div>

<app-consensus-dialog
  *ngIf="showConsensusDialog"
  [miner]="miner"
  (close)="onConsensusDialogClose()"
  (versionChange)="onConsensusVersionChange()"
></app-consensus-dialog>
