<div class="flex flex-col w-full h-full">
  <div
    class="relative overflow-hidden bg-zinc-900 border border-zinc-800 rounded-lg p-4 flex-1"
  >
    <div class="font-semibold text-blue-400 mb-2 flex items-center gap-2">
      <span>Eventos</span>
      <span class="text-xs text-zinc-400">({{ node.eventLog.length }})</span>
    </div>
    <ul class="space-y-1 text-xs pr-1">
      <li
        *ngFor="let event of node.eventLog | slice : 0 : 15"
        [ngClass]="{
          'text-green-400':
            event.type === 'block-validated' || event.type === 'block-mined',
          'text-red-400': event.type === 'block-rejected',
          'text-blue-400': event.type === 'block-received',
          'text-yellow-400': event.type === 'sync-progress'
        }"
      >
        <span class="font-mono">{{
          event.timestamp | date : "shortTime"
        }}</span>
        <span *ngIf="event.type === 'block-validated'">‚úîÔ∏è</span>
        <span *ngIf="event.type === 'block-rejected'">‚ùå</span>
        <span *ngIf="event.type === 'block-received'">‚¨áÔ∏è</span>
        <span *ngIf="event.type === 'sync-progress'">üîÑ</span>
        <span *ngIf="event.type === 'block-mined'">‚õèÔ∏è</span>
        <span class="ml-1">
          {{
            event.type === "block-validated"
              ? "validado"
              : event.type === "block-received"
              ? "recebido"
              : event.type === "block-rejected"
              ? "rejeitado"
              : event.type === "sync-progress"
              ? "sincronizando"
              : event.type === "block-mined"
              ? "minerado"
              : event.type
          }}
        </span>
        <span *ngIf="event.type !== 'sync-progress'" class="ml-1 text-zinc-400">
          ({{ event.block?.hash | slice : 0 : 32 }}... v{{
            event.block?.consensusVersion || "-"
          }})
        </span>
        <span
          *ngIf="event.type === 'sync-progress'"
          class="ml-1 text-yellow-300"
        >
          <ng-container
            *ngIf="event.reason === 'sync-complete'; else syncProgressDetail"
          >
            {{ event.message }}: {{ event.syncProgress?.processed }}/{{
              event.syncProgress?.total
            }}
            blocos
          </ng-container>
          <ng-template #syncProgressDetail>
            <ng-container
              *ngIf="
                event.syncProgress?.processed === 0;
                else syncProgressRunning
              "
            >
              Sincroniza√ß√£o iniciada: {{ event.syncProgress?.total }} blocos a
              baixar...
            </ng-container>
            <ng-template #syncProgressRunning>
              Sincronizando: {{ event.syncProgress?.processed }}/{{
                event.syncProgress?.total
              }}
              blocos ({{
                event.syncProgress?.blocksPerSecond | number : "1.0-0"
              }}
              blocos/s,
              {{
                event.syncProgress?.estimatedTimeRemaining | number : "1.0-0"
              }}s restantes)
            </ng-template>
          </ng-template>
        </span>
        <span
          *ngIf="event.message && event.type !== 'sync-progress'"
          class="ml-1 text-red-300"
        >
          ({{ event.message }})
        </span>
      </li>
      <li *ngIf="node.eventLog.length === 0" class="text-zinc-500 italic">
        Nenhum evento ainda.
      </li>
    </ul>
    <!-- Fade and button will go here -->
    <div
      *ngIf="node.eventLog.length > 8"
      class="absolute left-0 right-0 bottom-0 h-1/4 pointer-events-none bg-gradient-to-t from-zinc-900 to-transparent"
    ></div>
    <button
      *ngIf="node.eventLog.length > 8"
      (click)="showNodeLogs()"
      class="absolute right-3 bottom-3 z-10 px-2 py-1 text-xs rounded bg-blue-700 text-white font-semibold shadow hover:bg-blue-800 transition pointer-events-auto backdrop-blur-sm"
    >
      Ver tudo
    </button>
  </div>
</div>

<!-- Dialog de todos os logs -->
<ng-template [ngIf]="showAllLogs && node">
  <div
    class="fixed inset-0 bg-black/60 flex items-center justify-center z-50 !m-0 backdrop-blur"
    (click)="closeLogs()"
  >
    <div
      class="bg-zinc-900 border border-zinc-800 rounded-lg p-6 w-full max-w-lg h-[80vh] flex flex-col shadow-xl"
      (click)="$event.stopPropagation()"
    >
      <div class="flex items-center justify-between mb-4">
        <span class="font-semibold text-blue-400"
          >Eventos do N√≥ #{{ node.id }}</span
        >
        <button
          (click)="closeLogs()"
          class="text-zinc-400 hover:text-red-400 text-xl"
        >
          &times;
        </button>
      </div>
      <ul class="flex-1 overflow-y-auto space-y-1 text-xs pr-1">
        <li
          *ngFor="let event of node.eventLog"
          [ngClass]="{
            'text-green-400':
              event.type === 'block-validated' || event.type === 'block-mined',
            'text-red-400': event.type === 'block-rejected',
            'text-blue-400': event.type === 'block-received',
            'text-yellow-400': event.type === 'sync-progress'
          }"
        >
          <span class="font-mono">{{
            event.timestamp | date : "shortTime"
          }}</span>
          <span *ngIf="event.type === 'block-validated'">‚úîÔ∏è</span>
          <span *ngIf="event.type === 'block-rejected'">‚ùå</span>
          <span *ngIf="event.type === 'block-received'">‚¨áÔ∏è</span>
          <span *ngIf="event.type === 'sync-progress'">üîÑ</span>
          <span *ngIf="event.type === 'block-mined'">‚õèÔ∏è</span>
          <span class="ml-1">
            {{
              event.type === "block-validated"
                ? "validado"
                : event.type === "block-received"
                ? "recebido"
                : event.type === "block-rejected"
                ? "rejeitado"
                : event.type === "sync-progress"
                ? "sincronizando"
                : event.type === "block-mined"
                ? "minerado"
                : event.type
            }}
          </span>
          <span
            *ngIf="event.type !== 'sync-progress'"
            class="ml-1 text-zinc-400"
            >({{ event.block?.hash | slice : 0 : 32 }}... v
            {{ event.block?.consensusVersion || "-" }})
          </span>
          <span
            *ngIf="event.type === 'sync-progress'"
            class="ml-1 text-yellow-300"
          >
            <ng-container
              *ngIf="event.reason === 'sync-complete'; else syncProgressDetail"
            >
              {{ event.message }}: {{ event.syncProgress?.processed }}/{{
                event.syncProgress?.total
              }}
              blocos
            </ng-container>
            <ng-template #syncProgressDetail>
              <ng-container
                *ngIf="
                  event.syncProgress?.processed === 0;
                  else syncProgressRunning
                "
              >
                Sincroniza√ß√£o iniciada: {{ event.syncProgress?.total }} blocos a
                baixar...
              </ng-container>
              <ng-template #syncProgressRunning>
                Sincronizando: {{ event.syncProgress?.processed }}/{{
                  event.syncProgress?.total
                }}
                blocos ({{
                  event.syncProgress?.blocksPerSecond | number : "1.0-0"
                }}
                blocos/s,
                {{
                  event.syncProgress?.estimatedTimeRemaining | number : "1.0-0"
                }}s restantes)
              </ng-template>
            </ng-template>
          </span>
          <span
            *ngIf="event.message && event.type !== 'sync-progress'"
            class="ml-1 text-red-300"
          >
            ({{ event.message }})
          </span>
        </li>
      </ul>
    </div>
  </div>
</ng-template>
