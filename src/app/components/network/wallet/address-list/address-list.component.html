<div class="flex flex-col h-full">
  <div class="flex items-center justify-between pb-4 px-6">
    <div class="flex items-center gap-2">
      <h3 *ngIf="!hideTitle" class="text-lg font-semibold text-zinc-200">
        Endereços
      </h3>
      <button
        *ngIf="canDeriveNextAddress"
        type="button"
        class="flex items-center gap-2 px-3 py-1 rounded border border-blue-500 text-blue-500 bg-transparent hover:bg-blue-500 hover:text-white transition text-sm shadow-sm"
        (click)="deriveNextAddress.emit()"
        title="Gerar novo endereço"
      >
        <i class="pi pi-plus"></i>
        <span class="hidden sm:inline">Gerar novo endereço</span>
      </button>
    </div>
    <div class="flex gap-2">
      <button
        type="button"
        class="px-3 py-1 rounded text-sm transition"
        [class.bg-green-600]="addressType === 'bip44'"
        [class.text-white]="addressType === 'bip44'"
        [class.bg-zinc-700]="addressType !== 'bip44'"
        [class.text-zinc-300]="addressType !== 'bip44'"
        (click)="onAddressTypeChange('bip44')"
      >
        Legacy
      </button>
      <button
        type="button"
        class="px-3 py-1 rounded text-sm transition"
        [class.bg-blue-600]="addressType === 'bip49'"
        [class.text-white]="addressType === 'bip49'"
        [class.bg-zinc-700]="addressType !== 'bip49'"
        [class.text-zinc-300]="addressType !== 'bip49'"
        (click)="onAddressTypeChange('bip49')"
      >
        SegWit
      </button>
      <button
        type="button"
        class="px-3 py-1 rounded text-sm transition"
        [class.bg-purple-600]="addressType === 'bip84'"
        [class.text-white]="addressType === 'bip84'"
        [class.bg-zinc-700]="addressType !== 'bip84'"
        [class.text-zinc-300]="addressType !== 'bip84'"
        (click)="onAddressTypeChange('bip84')"
      >
        Native SegWit
      </button>
      <button
        type="button"
        class="px-3 py-1 rounded text-sm transition"
        [class.bg-yellow-600]="addressType === 'all-bip-types'"
        [class.text-white]="addressType === 'all-bip-types'"
        [class.bg-zinc-700]="addressType !== 'all-bip-types'"
        [class.text-zinc-300]="addressType !== 'all-bip-types'"
        (click)="onAddressTypeChange('all-bip-types')"
      >
        Todos
      </button>
    </div>
  </div>
  <div class="flex-1 min-h-0 flex flex-col">
    <p-table
      class="w-full h-full flex-1 text-sm overflow-hidden table-fixed"
      [value]="addresses"
      dataKey="address"
      [style]="{ 'font-size': '0.95rem', width: '100%', height: '100%' }"
      [scrollable]="true"
      [scrollHeight]="'100%'"
      rowExpandMode="multiple"
      [rowTrackBy]="rowTrackBy"
    >
      <ng-template #header>
        <tr class="bg-zinc-900 text-zinc-300">
          <th class="text-left p-4 w-[5%]"></th>
          <th class="px-4 py-2 text-left w-[5%]">#</th>
          <th class="px-4 py-2 text-left w-[60%]">Endereço</th>
          <th class="px-4 py-2 text-right w-[15%]">Saldo (BTC)</th>
          <th class="px-4 py-2 text-right w-[15%]">UTXOs</th>
        </tr>
      </ng-template>
      <ng-template #body let-data let-index="rowIndex" let-expanded="expanded">
        <tr class="border-b border-zinc-700 last:border-0">
          <td class="p-4 align-middle flex items-center">
            <button
              pButton
              type="button"
              [icon]="expanded ? 'pi pi-chevron-down' : 'pi pi-chevron-right'"
              [pRowToggler]="data"
              class="p-button-text p-0 text-white/70 hover:text-white focus:ring-0 focus:outline-none"
              style="height: 1.7rem; width: 1.7rem"
              [attr.aria-label]="expanded ? 'Colapsar' : 'Expandir'"
            ></button>
            <i
              *ngIf="data.nodeId === nodeId"
              class="pi pi-verified text-blue-400 text-xs ml-1"
              title="Este endereço pertence a este nó"
            ></i>
          </td>
          <td class="px-4 py-2 text-zinc-500 font-mono">
            {{ first + index + 1 }}
          </td>
          <td
            class="px-4 py-2 font-mono break-all"
            [class.text-green-300]="data.addressType === 'bip44'"
            [class.text-blue-300]="data.addressType === 'bip49'"
            [class.text-purple-300]="data.addressType === 'bip84'"
          >
            {{ data.address }}
          </td>
          <td class="px-4 py-2 text-right font-mono text-zinc-200">
            {{ data.balance / 100000000 | number : "1.8-8" }}
          </td>
          <td class="px-4 py-2 text-right font-mono text-zinc-200">
            {{ data.utxos.length }}
          </td>
        </tr>
      </ng-template>
      <ng-template pTemplate="emptymessage">
        <tr>
          <td colspan="5" class="text-center text-zinc-500 italic py-8">
            Nenhum endereço encontrado para os filtros selecionados.
          </td>
        </tr>
      </ng-template>
      <ng-template #expandedrow let-data let-index="rowIndex">
        <tr>
          <td colspan="5" class="p-0">
            <div class="w-full p-4">
              <div class="space-y-4">
                <div class="transition-all duration-300">
                  <div class="flex items-center gap-2 mb-2">
                    <span class="text-xs text-zinc-400 mb-2 font-semibold"
                      >Detalhes do Endereço #{{ index + 1 }}</span
                    >
                  </div>

                  <div class="space-y-2">
                    <div>
                      <label class="block text-xs text-zinc-500 mb-1"
                        >Chave Privada</label
                      >
                      <div class="flex flex-col gap-1">
                        <div class="flex items-center gap-2">
                          <label class="text-xs text-zinc-500 mb-1 min-w-[60px]"
                            >Hex:</label
                          >
                          <div
                            class="flex-1 bg-zinc-800/50 rounded p-2 font-mono text-xs text-zinc-500 break-all flex items-center gap-2 min-h-[2.2rem]"
                          >
                            <ng-container
                              *ngIf="data.keys.priv.hex; else lockedPrivHex"
                            >
                              <span class="text-green-300 text-sm"
                                >0x{{ data.keys.priv.hex }}</span
                              >
                            </ng-container>
                            <ng-template #lockedPrivHex>
                              <span
                                class="flex items-center gap-1"
                                title="Chave não disponível para este endereço"
                              >
                                <i class="pi pi-lock text-[0.9em]"></i>
                                <span class="italic tracking-wide"
                                  >Chave não disponível</span
                                >
                              </span>
                            </ng-template>
                          </div>
                          <button
                            *ngIf="data.keys.priv.hex"
                            (click)="copyToClipboard(data.keys.priv.hex)"
                            class="p-2 text-zinc-400 hover:text-blue-400 transition-colors"
                            title="Copiar chave privada"
                          >
                            <i class="pi pi-copy"></i>
                          </button>
                        </div>
                        <div class="flex items-center gap-2">
                          <label class="text-xs text-zinc-500 mb-1 min-w-[60px]"
                            >Decimal:</label
                          >
                          <div
                            class="flex-1 bg-zinc-800/50 rounded p-2 font-mono text-xs text-zinc-500 break-all flex items-center gap-2 min-h-[2.2rem]"
                            [title]="
                              data.keys.priv.decimal
                                ? (data.keys.priv.decimal | number : '1.0-0')
                                : 'Chave não disponível para este endereço'
                            "
                          >
                            <ng-container
                              *ngIf="
                                data.keys.priv.decimal;
                                else lockedPrivDecimal
                              "
                            >
                              <span class="text-green-300 text-sm">{{
                                data.keys.priv.decimal
                              }}</span>
                            </ng-container>
                            <ng-template #lockedPrivDecimal>
                              <span class="flex items-center gap-1">
                                <i class="pi pi-lock text-[0.9em]"></i>
                                <span class="italic tracking-wide"
                                  >Chave não disponível</span
                                >
                              </span>
                            </ng-template>
                          </div>
                          <button
                            *ngIf="data.keys.priv.decimal"
                            (click)="copyToClipboard(data.keys.priv.decimal)"
                            class="p-2 text-zinc-400 hover:text-blue-400 transition-colors"
                            title="Copiar chave privada"
                          >
                            <i class="pi pi-copy"></i>
                          </button>
                        </div>
                        <div class="flex items-center gap-2">
                          <label class="text-xs text-zinc-500 mb-1 min-w-[60px]"
                            >WIF:</label
                          >
                          <div
                            class="flex-1 bg-zinc-800/50 rounded p-2 font-mono text-xs text-zinc-500 break-all flex items-center gap-2 min-h-[2.2rem]"
                          >
                            <ng-container
                              *ngIf="data.keys.priv.wif; else lockedPrivWif"
                            >
                              <span class="text-green-300 text-sm">{{
                                data.keys.priv.wif
                              }}</span>
                            </ng-container>
                            <ng-template #lockedPrivWif>
                              <span
                                class="flex items-center gap-1"
                                title="Chave não disponível para este endereço"
                              >
                                <i class="pi pi-lock text-[0.9em]"></i>
                                <span class="italic tracking-wide"
                                  >Chave não disponível</span
                                >
                              </span>
                            </ng-template>
                          </div>
                          <button
                            *ngIf="data.keys.priv.wif"
                            (click)="copyToClipboard(data.keys.priv.wif)"
                            class="p-2 text-zinc-400 hover:text-blue-400 transition-colors"
                            title="Copiar chave privada"
                          >
                            <i class="pi pi-copy"></i>
                          </button>
                        </div>
                      </div>
                    </div>

                    <div>
                      <label class="block text-xs text-zinc-500 mb-1"
                        >Chave Pública</label
                      >
                      <div class="flex flex-col gap-1">
                        <div class="flex items-center gap-2">
                          <label class="text-xs text-zinc-500 mb-1 min-w-[60px]"
                            >Hex:</label
                          >
                          <div
                            class="flex-1 bg-zinc-800/50 rounded p-2 font-mono text-xs text-zinc-500 break-all flex items-center gap-2 min-h-[2.2rem]"
                          >
                            <ng-container
                              *ngIf="data.keys.pub.hex; else lockedPubHex"
                            >
                              <span class="text-blue-300 text-sm"
                                >0x{{ data.keys.pub.hex }}</span
                              >
                            </ng-container>
                            <ng-template #lockedPubHex>
                              <span
                                class="flex items-center gap-1"
                                title="Chave não disponível para este endereço"
                              >
                                <i class="pi pi-lock text-[0.9em]"></i>
                                <span class="italic tracking-wide"
                                  >Chave não disponível</span
                                >
                              </span>
                            </ng-template>
                          </div>
                          <button
                            *ngIf="data.keys.pub.hex"
                            (click)="copyToClipboard(data.keys.pub.hex)"
                            class="p-2 text-zinc-400 hover:text-blue-400 transition-colors"
                            title="Copiar chave pública"
                          >
                            <i class="pi pi-copy"></i>
                          </button>
                        </div>
                        <div class="flex items-center gap-2">
                          <label class="text-xs text-zinc-500 mb-1 min-w-[60px]"
                            >Decimal:</label
                          >
                          <div
                            class="flex-1 bg-zinc-800/50 rounded p-2 font-mono text-xs text-zinc-500 break-all flex items-center gap-2 min-h-[2.2rem]"
                            [title]="
                              data.keys.pub.decimal
                                ? (data.keys.pub.decimal | number : '1.0-0')
                                : 'Chave não disponível para este endereço'
                            "
                          >
                            <ng-container
                              *ngIf="
                                data.keys.pub.decimal;
                                else lockedPubDecimal
                              "
                            >
                              <span class="text-blue-300 text-sm">{{
                                data.keys.pub.decimal
                              }}</span>
                            </ng-container>
                            <ng-template #lockedPubDecimal>
                              <span class="flex items-center gap-1">
                                <i class="pi pi-lock text-[0.9em]"></i>
                                <span class="italic tracking-wide"
                                  >Chave não disponível</span
                                >
                              </span>
                            </ng-template>
                          </div>
                          <button
                            *ngIf="data.keys.pub.decimal"
                            (click)="copyToClipboard(data.keys.pub.decimal)"
                            class="p-2 text-zinc-400 hover:text-blue-400 transition-colors"
                            title="Copiar chave pública"
                          >
                            <i class="pi pi-copy"></i>
                          </button>
                        </div>
                      </div>
                    </div>

                    <div>
                      <label class="block text-xs text-zinc-500 mb-1"
                        >UTXOs</label
                      >
                      <div
                        *ngIf="data.utxos.length > 0; else noUtxos"
                        class="flex flex-col gap-4"
                      >
                        <div
                          *ngFor="
                            let utxo of getUtxosPage(data.address, data.utxos)
                          "
                          class="bg-gradient-to-br from-zinc-800 to-zinc-900 rounded-lg shadow-lg p-6 flex items-center gap-6 border-2 border-zinc-700 relative overflow-hidden"
                        >
                          <!-- Marca d'água -->
                          <div
                            class="absolute inset-0 flex items-center justify-center opacity-5 pointer-events-none"
                          >
                            <i
                              class="pi pi-bitcoin text-[200px] text-white"
                            ></i>
                          </div>

                          <!-- Elementos decorativos -->
                          <div
                            class="absolute top-0 left-0 w-16 h-16 border-t-2 border-l-2 border-zinc-600"
                          ></div>
                          <div
                            class="absolute bottom-0 right-0 w-16 h-16 border-b-2 border-r-2 border-zinc-600"
                          ></div>

                          <!-- Ícone e valor principal -->
                          <div
                            class="flex items-center justify-center bg-gradient-to-br from-blue-900 to-blue-800 rounded-full w-16 h-16 shadow-lg relative"
                          >
                            <i
                              class="pi pi-money-bill text-3xl text-blue-300"
                            ></i>
                          </div>

                          <div class="flex-1 relative">
                            <!-- Valor em destaque -->
                            <div
                              class="text-2xl font-bold text-green-300 flex items-center gap-2 mb-2"
                            >
                              {{
                                utxo.output.value / 100000000 | number : "1.8-8"
                              }}
                              <span class="text-base text-zinc-400">BTC</span>
                            </div>

                            <!-- Número de série (TxID) -->
                            <div
                              class="text-xs text-zinc-400 mt-3 font-mono tracking-wider"
                            >
                              <span class="text-zinc-500">Nº de Série:</span>
                              <span class="ml-2 break-all">{{
                                utxo.txId
                              }}</span>
                            </div>

                            <!-- Out como referência -->
                            <div class="text-xs text-zinc-400 mt-1 font-mono">
                              <span class="text-zinc-500">Referência:</span>
                              <span class="ml-2">{{ utxo.outputIndex }}</span>
                            </div>

                            <!-- Explicação didática -->
                            <div
                              class="text-xs text-zinc-500 mt-3 italic border-t border-zinc-700 pt-3"
                            >
                              <span class="font-semibold text-zinc-400"
                                >UTXO</span
                              >
                              = "Unspent Transaction Output"<br />
                              Pense como uma nota digital: para gastar, é
                              preciso assinar com a chave privada
                              correspondente.
                            </div>
                          </div>

                          <!-- Elemento decorativo direito -->
                          <div
                            class="absolute right-4 top-1/2 -translate-y-1/2 opacity-20"
                          >
                            <i
                              class="pi pi-shield text-[100px] text-blue-400"
                            ></i>
                          </div>
                        </div>
                      </div>
                      <app-pagination-bar
                        *ngIf="
                          data.utxos.length >
                          (utxoPagination[data.address]?.pageSize || 10)
                        "
                        [currentPage]="
                          utxoPagination[data.address]?.currentPage || 1
                        "
                        [totalPages]="
                          getUtxoTotalPages(data.address, data.utxos)
                        "
                        [percent]="
                          ((utxoPagination[data.address]?.currentPage || 1) /
                            getUtxoTotalPages(data.address, data.utxos)) *
                          100
                        "
                        [prevDisabled]="
                          (utxoPagination[data.address]?.currentPage || 1) === 1
                        "
                        [nextDisabled]="
                          (utxoPagination[data.address]?.currentPage || 1) ===
                          getUtxoTotalPages(data.address, data.utxos)
                        "
                        (goToFirst)="goToUtxoPage(data.address, 1, data.utxos)"
                        (goToPrevious)="
                          goToUtxoPage(
                            data.address,
                            (utxoPagination[data.address]?.currentPage || 1) -
                              1,
                            data.utxos
                          )
                        "
                        (goToNext)="
                          goToUtxoPage(
                            data.address,
                            (utxoPagination[data.address]?.currentPage || 1) +
                              1,
                            data.utxos
                          )
                        "
                        (goToLast)="
                          goToUtxoPage(
                            data.address,
                            getUtxoTotalPages(data.address, data.utxos),
                            data.utxos
                          )
                        "
                        (jumpToPage)="
                          goToUtxoPage(data.address, $event, data.utxos)
                        "
                      ></app-pagination-bar>
                      <ng-template #noUtxos>
                        <div class="text-zinc-500 italic py-4">
                          Nenhum UTXO encontrado para este endereço.
                        </div>
                      </ng-template>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </td>
        </tr>
      </ng-template>
    </p-table>
  </div>
</div>
