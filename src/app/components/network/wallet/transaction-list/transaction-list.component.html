<div class="flex flex-col h-full">
  <div class="flex-1 min-h-0 flex flex-col">
    <p-table
      class="w-full h-full flex-1 text-sm overflow-hidden table-fixed"
      [value]="transactions"
      dataKey="id"
      [style]="{ 'font-size': '0.95rem', width: '100%', height: '100%' }"
      [scrollable]="true"
      [scrollHeight]="'100%'"
      rowExpandMode="multiple"
    >
      <ng-template pTemplate="header">
        <tr>
          <th style="width: 3rem"></th>
          <th class="px-3 py-2 font-semibold">#</th>
          <th class="px-3 py-2 font-semibold">Data/Hora</th>
          <th class="px-3 py-2 font-semibold">Tipo</th>
          <th class="px-3 py-2 font-semibold">Valor (BTC)</th>
          <th class="font-semibold"></th>
          <th class="px-3 py-2 font-semibold">Endereço</th>
          <th class="px-3 py-2 font-semibold">Status</th>
          <th class="px-3 py-2 font-semibold">TxID</th>
        </tr>
      </ng-template>
      <ng-template
        pTemplate="body"
        let-tx
        let-expanded="expanded"
        let-rowIndex="rowIndex"
      >
        <tr>
          <td class="px-3 py-2 align-middle">
            <button
              [pRowToggler]="tx"
              type="button"
              class="p-0 m-0 text-zinc-400 hover:text-blue-400 focus:outline-none"
              [attr.aria-label]="
                expanded ? 'Colapsar detalhes' : 'Expandir detalhes'
              "
            >
              <i
                class="pi"
                [ngClass]="expanded ? 'pi-chevron-down' : 'pi-chevron-right'"
              ></i>
            </button>
          </td>
          <td class="px-3 py-2 text-zinc-500 font-mono">
            {{ totalTransactions - (currentPage - 1) * pageSize - rowIndex }}
          </td>
          <td class="px-3 py-2">
            {{
              tx.timestamp ? (tx.timestamp | date : "dd/MM/yyyy HH:mm:ss") : "—"
            }}
          </td>
          <td
            class="px-3 py-2"
            [ngClass]="{
              'text-green-400': tx.type === 'Recebida',
              'text-red-400': tx.type === 'Enviada',
              'text-yellow-400': tx.type === 'Coinbase',
              'text-purple-400': tx.type === 'Interna'
            }"
          >
            <ng-container [ngSwitch]="tx.type">
              <i
                *ngSwitchCase="'Recebida'"
                class="pi pi-arrow-down-left mr-1"
              ></i>
              <i
                *ngSwitchCase="'Enviada'"
                class="pi pi-arrow-up-right mr-1"
              ></i>
              <i *ngSwitchCase="'Coinbase'" class="pi pi-star-fill mr-1"></i>
              <i *ngSwitchCase="'Interna'" class="pi pi-sync mr-1"></i>
              <i *ngSwitchDefault class="pi pi-info-circle mr-1"></i>
            </ng-container>
            {{ tx.type === "Interna" ? "Transferência interna" : tx.type }}
          </td>
          <td class="px-3 py-2">
            {{ tx.value / 100000000 | number : "1.8-8" }}
          </td>
          <td>
            <i
              *ngIf="!walletAddresses.includes(tx.address)"
              class="pi pi-globe text-yellow-400"
              title="Endereço externo"
            ></i>
          </td>
          <td
            class="px-4 py-2 font-mono break-all"
            [class.text-green-300]="tx.bipType === 'bip44'"
            [class.text-blue-300]="tx.bipType === 'bip49'"
            [class.text-purple-300]="tx.bipType === 'bip84'"
          >
            <a
              [routerLink]="['/miners', nodeId, 'addresses', tx.address]"
              class="hover:underline"
            >
              {{ tx.address }}
            </a>
          </td>
          <td class="px-3 py-2">{{ tx.status }}</td>
          <td
            class="px-3 py-2 font-mono text-xs text-blue-300 truncate max-w-[180px]"
            [title]="tx.id"
          >
            {{ tx.id }}
          </td>
        </tr>
      </ng-template>
      <ng-template pTemplate="rowexpansion" let-tx>
        <tr>
          <td colspan="8" class="bg-zinc-900/60 px-6 py-3">
            <div class="text-xs text-zinc-400 mb-2 font-semibold">
              Detalhes da transação
            </div>
            <div class="flex flex-col gap-3">
              <app-utxo
                *ngFor="let d of tx.details"
                [value]="d.value"
                [address]="d.address"
                [txid]="d.txId || ''"
                [vout]="d.vout ?? 0"
                [isSpent]="d.type === 'input'"
                [isChange]="d.type === 'change'"
                [isWallet]="d.isWallet"
                [isCoinbase]="tx.type === 'Coinbase'"
                [compact]="true"
                [showActions]="true"
                [context]="d.type === 'input' ? 'input' : 'output'"
                [isVirtual]="false"
                [scriptSig]="d.scriptSig"
              ></app-utxo>
            </div>
          </td>
        </tr>
      </ng-template>
      <ng-template pTemplate="emptymessage">
        <tr>
          <td colspan="8" class="text-center text-zinc-500 italic py-8">
            Nenhuma transação encontrada para os filtros selecionados.
          </td>
        </tr>
      </ng-template>
    </p-table>
  </div>
</div>
