<div class="w-full h-full flex-1 flex flex-col min-h-0">
  <!-- Tabs header -->
  <div class="flex border-b border-zinc-700 mb-2">
    <button
      class="px-4 py-2 font-semibold focus:outline-none transition border-b-2"
      [class.text-white]="activeTab === 'enderecos'"
      [class.text-zinc-400]="activeTab !== 'enderecos'"
      [class.border-blue-500]="activeTab === 'enderecos'"
      [class.border-transparent]="activeTab !== 'enderecos'"
      (click)="setActiveTab('enderecos')"
    >
      Endereços
    </button>
    <button
      class="px-4 py-2 font-semibold focus:outline-none transition border-b-2"
      [class.text-white]="activeTab === 'transacoes'"
      [class.text-zinc-400]="activeTab !== 'transacoes'"
      [class.border-blue-500]="activeTab === 'transacoes'"
      [class.border-transparent]="activeTab !== 'transacoes'"
      (click)="setActiveTab('transacoes')"
    >
      Transações
    </button>
    <button
      class="px-4 py-2 font-semibold focus:outline-none transition border-b-2"
      [class.text-white]="activeTab === 'enviar'"
      [class.text-zinc-400]="activeTab !== 'enviar'"
      [class.border-blue-500]="activeTab === 'enviar'"
      [class.border-transparent]="activeTab !== 'enviar'"
      (click)="setActiveTab('enviar')"
    >
      Enviar
    </button>
  </div>

  <!-- Tabs content -->
  <div class="flex-1 min-h-0 flex flex-col h-full">
    <div [hidden]="activeTab !== 'enderecos'" class="h-full">
      <div class="flex-1 min-h-0 flex flex-col h-full pt-4">
        <div class="flex-1 min-h-0 flex flex-col">
          <app-address-list
            [hideTitle]="true"
            [nodeId]="node.id"
            [addresses]="addressesDisplay"
            [pagination]="pagination"
            [canDeriveNextAddress]="true"
            [bipFormat]="bipFormat"
            (deriveNextAddress)="onDeriveNextAddress()"
            (bipFormatChange)="onChangeBipFormat($event)"
            class="flex-1 min-h-0"
          ></app-address-list>
          <app-pagination-bar
            *ngIf="totalPagesDisplay > 1"
            [currentPage]="currentPageDisplay"
            [totalPages]="totalPagesDisplay"
            [percent]="pagePercent"
            [prevDisabled]="prevDisabled"
            [nextDisabled]="nextDisabled"
            (goToFirst)="goToFirstPage()"
            (goToPrevious)="goToPreviousPage()"
            (goToNext)="goToNextPage()"
            (goToLast)="goToLastPage()"
            (jumpToPage)="jumpToPage($event)"
          ></app-pagination-bar>
        </div>
      </div>
    </div>
    <div [hidden]="activeTab !== 'transacoes'" class="h-full">
      <div class="flex-1 min-h-0 flex flex-col h-full pt-4">
        <app-transaction-list
          [nodeId]="node.id"
          [transactions]="pagedTransactionViews"
          [walletAddresses]="walletAddressesList"
          [totalTransactions]="transactionViews.length"
          [currentPage]="transactionCurrentPageDisplay"
          [pageSize]="transactionPagination.pageSize"
          class="flex-1 h-full"
        ></app-transaction-list>
        <app-pagination-bar
          *ngIf="transactionTotalPagesDisplay > 1"
          [currentPage]="transactionCurrentPageDisplay"
          [totalPages]="transactionTotalPagesDisplay"
          [percent]="transactionPagePercent"
          [prevDisabled]="transactionPrevDisabled"
          [nextDisabled]="transactionNextDisabled"
          (goToFirst)="transactionGoToFirstPage()"
          (goToPrevious)="transactionGoToPreviousPage()"
          (goToNext)="transactionGoToNextPage()"
          (goToLast)="transactionGoToLastPage()"
          (jumpToPage)="transactionJumpToPage($event)"
        ></app-pagination-bar>
      </div>
    </div>
    <div [hidden]="activeTab !== 'enviar'" class="h-full">
      <div class="flex-1 min-h-0 flex flex-row h-full pt-4 gap-8 px-4">
        <!-- Coluna do Formulário -->
        <div class="w-1/2 flex flex-col min-w-0">
          <form
            class="flex flex-col gap-6 w-full"
            (submit)="onSendTransaction($event)"
          >
            <h2 class="text-lg font-semibold text-white mb-2">
              Enviar transação
            </h2>
            <div class="flex flex-col gap-1">
              <label for="destino" class="text-zinc-400 text-sm"
                >Endereço de destino</label
              >
              <input
                id="destino"
                name="destino"
                type="text"
                [(ngModel)]="sendToAddress"
                (input)="onSendAddressChange()"
                (focus)="onSendAddressFocus()"
                (blur)="onSendAddressBlur()"
                [ngClass]="{
                  'border-red-500':
                    sendAddressTouched &&
                    !sendAddressFocused &&
                    sendToAddressValid === false,
                  'border-zinc-700': !(
                    sendAddressTouched &&
                    !sendAddressFocused &&
                    sendToAddressValid === false
                  )
                }"
                class="bg-zinc-800 border rounded px-3 py-2 text-white focus:outline-none focus:border-blue-400"
                placeholder="Endereço Bitcoin"
              />
              <div
                *ngIf="
                  sendAddressTouched &&
                  !sendAddressFocused &&
                  sendToAddressValid === false
                "
                class="text-xs text-red-400 mt-1"
              >
                {{ sendToAddressErrorMsg }}
              </div>
            </div>
            <div class="flex flex-col gap-1">
              <div class="flex justify-between items-center mt-4">
                <label for="valor" class="text-zinc-400 text-sm"
                  >Valor (BTC)</label
                >
                <!-- Saldo disponível -->
                <div class="flex items-center gap-2">
                  <span class="text-zinc-400 text-xs">Saldo disponível:</span>
                  <span
                    class="font-mono text-blue-400 text-xs"
                    title="Saldo total disponível para envio"
                    >{{
                      projectedBalance / 100000000 | number : "1.8-8"
                    }}
                    BTC</span
                  >
                  <i class="pi pi-wallet text-blue-400"></i>
                </div>
              </div>
              <input
                id="valor"
                name="valor"
                type="number"
                step="any"
                min="0"
                [(ngModel)]="sendAmount"
                (input)="onSendAmountChange()"
                (focus)="onSendAmountFocus()"
                (blur)="onSendAmountBlur()"
                [ngClass]="{
                  'border-red-500':
                    sendAmountTouched &&
                    !sendAmountFocused &&
                    sendAmountValid === false,
                  'border-zinc-700': !(
                    sendAmountTouched &&
                    !sendAmountFocused &&
                    sendAmountValid === false
                  )
                }"
                class="bg-zinc-800 border rounded px-3 py-2 text-white focus:outline-none focus:border-blue-400"
                placeholder="0.00000000"
              />
              <div
                *ngIf="
                  sendAmountTouched &&
                  !sendAmountFocused &&
                  sendAmountValid === false
                "
                class="text-xs text-red-400 mt-1"
              >
                {{ sendAmountErrorMsg }}
              </div>
            </div>

            <!-- Seletor de Modo de UTXO -->
            <div class="flex flex-col gap-2">
              <label class="text-zinc-400 text-sm"
                >Seleção de Inputs (UTXOs)</label
              >
              <div class="flex rounded-md shadow-sm w-full">
                <button
                  type="button"
                  (click)="setUtxoSelectionMode('auto')"
                  class="flex-1 p-2 text-sm font-medium transition-colors rounded-l-md"
                  [ngClass]="{
                    'bg-blue-600 text-white z-10 border-blue-500':
                      utxoSelectionMode === 'auto',
                    'bg-zinc-700 hover:bg-zinc-600 text-zinc-300 border-zinc-600':
                      utxoSelectionMode !== 'auto'
                  }"
                >
                  Automática
                </button>
                <button
                  type="button"
                  (click)="setUtxoSelectionMode('manual')"
                  class="flex-1 p-2 text-sm font-medium transition-colors rounded-r-md -ml-px"
                  [ngClass]="{
                    'bg-blue-600 text-white z-10 border-blue-500':
                      utxoSelectionMode === 'manual',
                    'bg-zinc-700 hover:bg-zinc-600 text-zinc-300 border-zinc-600':
                      utxoSelectionMode !== 'manual'
                  }"
                >
                  Manual
                </button>
              </div>
            </div>

            <!-- Seletor de Modo de ASSINATURA -->
            <div class="flex flex-col gap-2 mt-2">
              <label class="text-zinc-400 text-sm">Assinatura dos Inputs</label>
              <div class="flex rounded-md shadow-sm w-full">
                <button
                  type="button"
                  (click)="setSignatureMode('auto')"
                  class="flex-1 p-2 text-sm font-medium transition-colors rounded-l-md"
                  [ngClass]="{
                    'bg-blue-600 text-white z-10 border-blue-500':
                      signatureMode === 'auto',
                    'bg-zinc-700 hover:bg-zinc-600 text-zinc-300 border-zinc-600':
                      signatureMode !== 'auto'
                  }"
                >
                  Automática
                </button>
                <button
                  type="button"
                  (click)="setSignatureMode('manual')"
                  class="flex-1 p-2 text-sm font-medium transition-colors rounded-r-md -ml-px"
                  [ngClass]="{
                    'bg-blue-600 text-white z-10 border-blue-500':
                      signatureMode === 'manual',
                    'bg-zinc-700 hover:bg-zinc-600 text-zinc-300 border-zinc-600':
                      signatureMode !== 'manual'
                  }"
                >
                  Manual
                </button>
              </div>
            </div>

            <!-- Lista de UTXOs para seleção manual -->
            <div
              *ngIf="utxoSelectionMode === 'manual'"
              class="flex flex-col gap-2"
            >
              <h4 class="text-zinc-300 text-sm">
                Selecione os UTXOs para gastar:
              </h4>
              <div
                class="max-h-60 overflow-y-auto space-y-2 p-3 bg-zinc-900/70 rounded-md border border-zinc-700"
              >
                <label
                  *ngFor="let utxo of allAvailableUtxos"
                  class="flex items-center gap-3 p-2 rounded-md transition-colors cursor-pointer w-full"
                  [ngClass]="{
                    'bg-blue-900/30': utxo.selected && utxo.isOwnedByWallet,
                    'bg-red-900/30': utxo.selected && !utxo.isOwnedByWallet,
                    'border-l-4 border-red-500': !utxo.isOwnedByWallet
                  }"
                >
                  <input
                    type="checkbox"
                    class="h-4 w-4 rounded bg-zinc-800 border-zinc-600 text-blue-600 focus:ring-blue-500 cursor-pointer"
                    [ngModel]="utxo.selected"
                    (ngModelChange)="
                      utxo.selected = $event; onManualUtxoSelectionChange()
                    "
                    [ngModelOptions]="{ standalone: true }"
                  />
                  <div class="flex-1 min-w-0">
                    <div class="flex items-center justify-between">
                      <span class="font-mono text-green-400 text-base">
                        {{ utxo.output.value / 100000000 | number : "1.8-8" }}
                        BTC
                      </span>
                      <div class="flex items-center gap-2">
                        <span class="text-xs text-zinc-400 font-mono">
                          Bloco:
                          <span class="text-white">{{ utxo.blockHeight }}</span>
                        </span>
                        <!-- Indicador visual para UTXOs "roubados" -->
                        <span
                          *ngIf="!utxo.isOwnedByWallet"
                          class="text-xs px-2 py-1 rounded bg-red-900/50 border border-red-700 text-red-200 font-semibold"
                          title="UTXO que não pertence à sua carteira (modo malicioso)"
                        >
                          🔓 EXTERNO
                        </span>
                      </div>
                    </div>
                    <div
                      class="text-xs text-zinc-500 font-mono truncate mt-1"
                      [title]="utxo.txId"
                    >
                      TXID:
                      <span class="text-white">{{ utxo.txId }}</span>
                      <span class="text-zinc-400 ml-2">vout:</span>
                      <span class="text-white">{{ utxo.outputIndex }}</span>
                    </div>
                    <div
                      class="text-xs text-zinc-500 font-mono truncate"
                      [title]="utxo.address"
                      [ngClass]="{
                        'text-red-300': !utxo.isOwnedByWallet,
                        'text-white': utxo.isOwnedByWallet
                      }"
                    >
                      {{ utxo.address }}
                    </div>
                  </div>
                </label>
                <div
                  *ngIf="allAvailableUtxos.length === 0"
                  class="text-center text-zinc-500 italic py-4"
                >
                  Nenhum UTXO disponível nesta carteira.
                </div>
              </div>
              <div class="text-right text-sm mt-1">
                <span class="text-zinc-400">Total Selecionado: </span>
                <span class="font-mono text-white font-semibold">
                  {{ manualSelectionTotal / 100000000 | number : "1.8-8" }}
                  BTC</span
                >
              </div>
              <!-- Aviso sobre modo malicioso -->
              <div
                *ngIf="node.isMalicious"
                class="mt-2 p-3 bg-red-900/30 border border-red-700 rounded-md"
              >
                <div
                  class="flex items-center gap-2 text-red-200 text-sm font-semibold"
                >
                  <i class="pi pi-exclamation-triangle"></i>
                  MODO MALICIOSO ATIVO
                </div>
                <p class="text-red-300 text-xs mt-1">
                  Você pode selecionar UTXOs que não pertencem à sua carteira.
                  Estes UTXOs aparecem marcados como "EXTERNO" e não podem ser
                  assinados corretamente, resultando em transações inválidas.
                </p>
              </div>
            </div>

            <div
              *ngIf="sendError"
              class="text-red-400 bg-red-900/30 border border-red-800 rounded px-3 py-2 text-sm font-medium"
            >
              {{ sendError }}
            </div>
            <div
              *ngIf="sendSuccess"
              class="text-green-400 bg-green-900/30 border border-green-800 rounded px-3 py-2 text-sm font-medium"
            >
              {{ sendSuccess }}
            </div>

            <div class="flex gap-2 justify-end mt-4">
              <button
                type="button"
                class="p-2 px-4 rounded bg-zinc-700 text-zinc-300 hover:bg-zinc-600"
                (click)="activeTab = 'transacoes'"
              >
                Cancelar
              </button>
              <button
                type="submit"
                [disabled]="
                  sendButtonDisabled ||
                  (signatureMode === 'manual' && !allInputsSigned)
                "
                [ngClass]="{
                  'bg-blue-600 text-white hover:bg-blue-500':
                    !sendButtonDisabled &&
                    (signatureMode === 'auto' || allInputsSigned),
                  'bg-zinc-800 text-zinc-500 cursor-not-allowed':
                    sendButtonDisabled ||
                    (signatureMode === 'manual' && !allInputsSigned)
                }"
                [style.cursor]="
                  sendButtonDisabled ||
                  (signatureMode === 'manual' && !allInputsSigned)
                    ? 'not-allowed'
                    : 'pointer'
                "
                class="p-2 px-4 rounded transition-colors"
              >
                Enviar
              </button>
            </div>
          </form>
        </div>

        <!-- Coluna do Preview -->
        <div class="w-1/2 min-w-0 flex flex-col">
          <!-- Preview da Transação -->
          <div
            *ngIf="showTransactionPreview"
            class="bg-zinc-800/50 border border-zinc-700 rounded-lg p-4"
          >
            <h3 class="text-white font-semibold mb-3 flex items-center gap-2">
              <i class="pi pi-eye text-blue-400"></i>
              Preview da Transação
            </h3>

            <!-- Resumo -->
            <div class="border-t border-zinc-700 pt-3 mb-6">
              <div class="flex justify-between items-center text-sm mb-1">
                <span class="text-zinc-400">Tamanho estimado:</span>
                <span class="text-yellow-400 font-mono"
                  >{{ previewTxSize }} bytes</span
                >
              </div>
              <div class="flex justify-between items-center text-sm">
                <span class="text-zinc-400">Total Input:</span>
                <span class="text-green-400 font-mono">
                  {{ previewTotalInput / 100000000 | number : "1.8-8" }} BTC
                </span>
              </div>
              <div class="flex justify-between items-center text-sm mt-1">
                <span class="text-zinc-400">Total Output:</span>
                <span class="text-red-400 font-mono">
                  {{ previewTotalOutput / 100000000 | number : "1.8-8" }} BTC
                </span>
              </div>
              <div class="flex justify-between items-center text-sm mt-1">
                <span class="text-zinc-400">Taxa:</span>
                <span class="text-yellow-400 font-mono">
                  {{ previewFee / 100000000 | number : "1.8-8" }} BTC
                </span>
              </div>
            </div>

            <!-- Inputs -->
            <div class="mb-6">
              <h4
                class="text-zinc-300 text-sm font-medium mb-3 flex items-center gap-2"
              >
                <i class="pi pi-arrow-right text-green-400"></i>
                Inputs - UTXOs a serem gastos ({{ previewInputs.length }})
              </h4>
              <!-- Aviso sobre inputs externos -->
              <div
                *ngIf="hasExternalInputs"
                class="mb-3 p-2 bg-red-900/30 border border-red-700 rounded-md"
              >
                <div
                  class="flex items-center gap-2 text-red-200 text-xs font-semibold"
                >
                  <i class="pi pi-exclamation-triangle"></i>
                  ATENÇÃO: Inputs "externos" detectados!
                </div>
                <p class="text-red-300 text-xs mt-1">
                  Esta transação contém UTXOs que não pertencem à sua carteira.
                  Eles não podem ser assinados corretamente e resultarão em uma
                  transação inválida.
                </p>
              </div>
              <div class="space-y-4">
                <app-utxo
                  *ngFor="
                    let input of previewInputs;
                    let i = index;
                    trackBy: trackByAddress
                  "
                  [value]="input.value"
                  [address]="input.address"
                  [txid]="input.txId"
                  [vout]="input.vout"
                  [scriptSig]="inputSignatureScripts[i] ?? undefined"
                  [blockHeight]="input.blockHeight"
                  [context]="'input'"
                  [compact]="false"
                  [showActions]="false"
                  [isVirtual]="true"
                  [signatureMode]="signatureMode"
                  [isInvalidSignature]="inputSignatureInvalid[i]"
                >
                  <ng-container *ngIf="signatureMode === 'manual'" assinatura>
                    <div class="flex flex-col gap-2 w-full py-2">
                      <div class="flex flex-row gap-2 items-center">
                        <p-select
                          [options]="availablePrivateKeys"
                          [(ngModel)]="selectedPrivateKey[i]"
                          optionLabel="address"
                          optionValue="privateKey"
                          placeholder="Selecione a chave"
                          [showClear]="true"
                          [ngModelOptions]="{ standalone: true }"
                          [filter]="true"
                          [appendTo]="'body'"
                          styleClass="max-w-xs w-full"
                          (onChange)="onPrivateKeySelectChange(i, $event.value)"
                        ></p-select>
                        <button
                          type="button"
                          (click)="
                            trySignInputWithKey(i, selectedPrivateKey[i]!)
                          "
                          class="px-4 py-1 rounded bg-blue-700 text-white text-xs font-semibold hover:bg-blue-600 transition-colors"
                          [disabled]="!selectedPrivateKey[i]"
                        >
                          Assinar Input
                        </button>
                      </div>
                      <div
                        *ngIf="!isInputOwnedByWallet(input)"
                        class="mt-1 text-xs text-red-400 font-semibold"
                      >
                        ⚠️ Este UTXO não pertence à sua carteira. Uma assinatura
                        falsa será gerada para fins didáticos.
                      </div>
                      <div
                        *ngIf="
                          !isInputOwnedByWallet(input) &&
                          inputSignatureErrors[i]
                        "
                        class="mt-1 text-xs text-orange-400 font-mono w-full text-left"
                      >
                        {{ inputSignatureErrors[i] }}
                      </div>
                      <div
                        *ngIf="
                          isInputOwnedByWallet(input) && inputSignatureErrors[i]
                        "
                        class="mt-1 text-xs text-red-400 font-mono w-full text-left"
                      >
                        {{ inputSignatureErrors[i] }}
                      </div>
                    </div>
                  </ng-container>
                </app-utxo>
              </div>
            </div>

            <!-- Outputs -->
            <div class="mb-4">
              <h4
                class="text-zinc-300 text-sm font-medium mb-3 flex items-center gap-2"
              >
                <i class="pi pi-arrow-left text-blue-400"></i>
                Outputs - Novos UTXOs a serem criados ({{
                  previewOutputs.length
                }})
              </h4>
              <div class="space-y-4">
                <app-utxo
                  *ngFor="
                    let output of previewOutputs;
                    let i = index;
                    trackBy: trackByAddress
                  "
                  [value]="output.value"
                  [address]="output.address"
                  [vout]="i"
                  [isChange]="output.type === 'change'"
                  [context]="'output'"
                  [compact]="false"
                  [showActions]="false"
                  [blockHeight]="node.currentBlock?.height ?? 0"
                  [isVirtual]="true"
                ></app-utxo>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<ng-template #keyTemplate let-key>
  <div class="font-mono">
    {{ key.address | slice : 0 : 8 }}... ({{
      key.privateKey | slice : 0 : 8
    }}...)
  </div>
</ng-template>
