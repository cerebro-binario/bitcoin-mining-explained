<div class="relative">
  <!-- Indicação visual de blockchain vazia -->
  <div
    *ngIf="node.heights.length <= 1"
    class="flex flex-col items-center justify-center py-16 text-zinc-500"
  >
    <i class="pi pi-database text-5xl mb-4"></i>
    <span class="text-lg font-semibold"
      >Nenhum bloco encontrado na blockchain local.</span
    >
    <span class="text-sm"
      >Aguarde a mineração do primeiro bloco ou conecte-se à rede.</span
    >
  </div>
  <cdk-virtual-scroll-viewport
    *ngIf="node.heights.length > 1"
    orientation="horizontal"
    [itemSize]="itemSize"
    [minBufferPx]="nToleratedItems * itemSize"
    [maxBufferPx]="nToleratedItems * itemSize"
    [style]="{
      width: '100%',
      height: blockchainContainerHeight + 'px',
      transition: 'height 0.6s ease-in-out',
      overflowY: 'hidden',
    }"
    (scrolledIndexChange)="onScrollIndexChange($event)"
  >
    <div
      #blockchainContainer
      [id]="'blockchain-container-' + node.id"
      class="flex flex-row items-stretch gap-16 px-16"
      [@slideRightAnimation]="{
        value: node.heights.length,
        params: {
          slideXValue
        }
      }"
    >
      <!-- Bloco atual -->
      <ng-container
        *cdkVirtualFor="let height of node.heights; trackBy: trackByHeight"
      >
        @let hIndex = node.getHeightIndex(height.n);
        @if(height.blocks[0].block.height === -1) { @let nChains =
        height.blocks[0].children.length;
        <div class="relative w-72 block" @blockAnimation>
          <div
            [id]="'originBlock-' + node.id"
            class="w-5 h-5 bg-zinc-500 rounded-full"
            [ngStyle]="{
                        transform: getOriginBlockTransform(nChains),
                        opacity: nChains > 1 ? 1 : 0,
                      }"
          ></div>
        </div>
        } @else {
        <div class="relative height-element flex gap-2">
          <!-- Coluna de eventos entre os blocos (após o primeiro bloco) -->
          <ng-container *ngIf="height.events.length > 0">
            <div
              class="h-full absolute flex flex-col items-center select-none -translate-x-1/2"
              [ngStyle]="{
                      left: '-' + gap.x.value / 2 + 'px',
                    }"
            >
              <div
                class="absolute h-full border-l-2 border-zinc-700/50 border-dotted -z-50"
              ></div>
              <div class="flex flex-col items-center gap-2 my-2 z-50">
                <ng-container *ngFor="let event of height.events">
                  <span
                    class="inline-flex items-center justify-center bg-zinc-900 border-4 border-zinc-800 p-2 text-xs rounded-full"
                    [ngClass]="(event.type | eventLogVisual).color"
                    [title]="event.type | eventLogMessage : event.data"
                    style="cursor: pointer"
                  >
                    <i
                      [class]="(event.type | eventLogVisual).icon + ' text-xs'"
                    ></i>
                  </span>
                </ng-container>
              </div>
            </div>
          </ng-container>
          <div
            class="relative py-2 flex flex-col gap-4 height-element-container"
          >
            <div
              *ngFor="let blockNode of height.blocks"
              class="relative block-element rounded-lg p-4 border w-72 shadow transition-transform cursor-pointer group flex flex-col overflow-visible"
              [ngClass]="[
                getBlockBackgroundColor(blockNode),
                getBlockBorderColor(blockNode)
              ]"
              @blockAnimation
              (@blockAnimation.start)="calculateGaps()"
              (click)="goToBlockDetails(blockNode.block)"
            >
              <div class="flex items-center justify-between mb-1">
                <div class="flex items-center gap-2">
                  <span
                    class="font-semibold text-blue-300 text-base flex items-center gap-2"
                  >
                    #{{ height.n }}
                  </span>
                  <span class="text-xs text-zinc-400">{{
                    blockNode.block.timestamp | date : "shortTime"
                  }}</span>
                </div>
                <div class="flex items-center gap-2">
                  <span
                    *ngIf="blockNode.block.miningElapsed"
                    class="text-xs text-zinc-400 bg-zinc-900/50 rounded px-2 py-0.5"
                    >⏱️
                    {{
                      (blockNode.block.miningElapsed / 1000).toFixed(1)
                    }}s</span
                  >
                  <span
                    *ngIf="blockNode.block.minerId"
                    class="text-xs text-blue-400 bg-blue-900/50 rounded px-2 py-0.5"
                    >Miner {{ blockNode.block.minerId }}</span
                  >
                  <span
                    class="text-xs text-purple-400 bg-purple-900/50 rounded px-2 py-0.5"
                    >v{{ blockNode.block.consensusVersion }}</span
                  >
                </div>
              </div>
              <div class="border-b border-zinc-700 my-1"></div>
              <div class="mb-1">
                <span class="text-zinc-400">Hash:</span>
                <div class="font-mono text-xs text-zinc-300 break-all">
                  {{ blockNode.block.hash }}
                </div>
              </div>
              <div class="mb-1">
                <span class="text-zinc-400">Anterior:</span>
                <div class="font-mono text-xs text-zinc-500 break-all">
                  {{ blockNode.block.previousHash }}
                </div>
              </div>
              <div class="flex flex-col gap-1 mt-1">
                <div>
                  <span class="text-zinc-400">Txs:</span>
                  <span class="font-mono text-xs text-zinc-300">
                    {{ blockNode.block.transactions.length }}
                  </span>
                </div>
                <div>
                  <span class="text-zinc-400">Nonce:</span>
                  <span class="font-mono text-xs text-zinc-300">
                    {{ blockNode.block.nonce | number }}
                  </span>
                </div>
                <div>
                  <span class="text-zinc-400">Recompensa:</span>
                  <span class="font-mono text-xs text-yellow-400">
                    {{
                      (blockNode.block.transactions[0].outputs[0].value || 0) /
                        100000000 | number : "1.8-8"
                    }}
                    BTC
                  </span>
                </div>
              </div>

              <!-- Conexões -->
              @if(blockNode.parent) {
              <div
                class="absolute bg-zinc-500 text-xs w-2.5 h-2.5 rounded-lg right-0 top-1/2 -translate-y-1/2 translate-x-1/2 z-10"
                [ngStyle]="{
                  'clip-path': 'polygon(50% 0%, 100% 0%, 100% 100%, 50% 100%)'
                }"
              ></div>
              <svg
                *ngIf="
                  blockNode.parent.block.height !== -1 ||
                  blockNode.parent.children.length > 1
                "
                class="absolute h-full w-full top-0 right-0 bottom-0 left-0 pointer-events-none overflow-visible z-0"
              >
                <path
                  [attr.d]="getCurvedPath(node, blockNode, hIndex)"
                  [attr.stroke]="
                    getConnectionStrokeColor(
                      blockNode,
                      isHeightResolved(hIndex)
                    )
                  "
                  stroke-width="2"
                  fill="transparent"
                />
              </svg>
              } @if(blockNode.children.length === 0 && hIndex > 0) {
              <div
                class="absolute w-3 h-3 -left-6 top-1/2 -translate-y-1/2 -translate-x-1/2 bg-zinc-400"
              ></div>
              <div
                class="absolute w-6 h-0.5 -left-6 top-1/2 -translate-y-1/2 bg-zinc-400"
              ></div>
              } @else if(blockNode.children.length > 0) {
              <div
                *ngFor="let child of blockNode.children; let i = index"
                class="absolute bg-zinc-500 text-xs w-2.5 h-2.5 rounded-lg left-0 -translate-y-1/2 -translate-x-1/2 z-10"
                [ngStyle]="{
                  top:
                    'calc(' +
                    getDynamicTopValue(blockNode.children.length, i) +
                    '%)',
                  'clip-path': 'polygon(0% 0%, 50% 0%, 50% 100%, 0% 100%)'
                }"
              ></div>
              }
            </div>
          </div>
        </div>
        }
      </ng-container>
    </div>
  </cdk-virtual-scroll-viewport>
</div>

<!-- Block Details Dialog -->
<app-block-details-dialog
  [isOpen]="isDialogOpen"
  [block]="selectedBlock!"
  [node]="node"
  [hasPrevBlock]="hasPrevBlock"
  [hasNextBlock]="hasNextBlock"
  (onClose)="onDialogClose()"
  (goPrevBlock)="onGoPrevBlock()"
  (goNextBlock)="onGoNextBlock()"
></app-block-details-dialog>
