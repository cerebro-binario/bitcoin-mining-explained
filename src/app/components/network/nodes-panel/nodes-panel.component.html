<div class="mb-12">
  <div class="flex items-center justify-between mb-4">
    <h2 class="text-2xl font-semibold">Nós da Rede</h2>
    <button
      class="px-4 py-2 rounded bg-blue-600 text-white font-semibold hover:bg-blue-700 transition"
      (click)="addNode()"
    >
      + Adicionar Nó
    </button>
  </div>
  <div *ngIf="nodes.length === 0" class="text-zinc-400 italic mb-4">
    Nenhum nó adicionado ainda.
  </div>
  <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
    <div
      *ngFor="let node of nodes; let i = index"
      class="bg-zinc-800 rounded-lg shadow p-6 flex flex-col gap-3 border border-zinc-700 items-center"
    >
      <div class="flex items-center gap-2 mb-2 w-full">
        <!-- Esquerda: Nome, status, peers -->
        <div class="flex items-center gap-2 flex-1 min-w-0">
          <span class="text-lg font-bold text-blue-400 truncate"
            >Nó #{{ node.id }}</span
          >
          <span class="text-xs text-zinc-400 ml-2" title="Versão do Consenso">
            v{{ node.consensus.version }}
          </span>
          <span class="flex items-center gap-2 ml-2">
            <span
              class="inline-block w-3 h-3 rounded-full border border-zinc-700"
              [ngClass]="{
                'bg-green-500': getStatusColor(node) === 'green',
                'bg-blue-500': getStatusColor(node) === 'blue',
                'bg-red-500': getStatusColor(node) === 'red'
              }"
              [title]="
                getStatusColor(node) === 'red'
                  ? 'Desconectado da rede'
                  : getStatusColor(node) === 'blue'
                  ? 'Sincronizando com peers'
                  : 'Conectado'
              "
            ></span>
            <span class="text-xs text-zinc-400"
              >{{ node.peers.length }} peers</span
            >
            <button
              class="ml-1 p-1 rounded-full transition align-middle relative overflow-hidden"
              (click)="searchPeers(node); $event.stopPropagation()"
              [disabled]="node.isSearchingPeers"
              [title]="
                node.isSearchingPeers
                  ? 'Procurando conexões...'
                  : 'Procurar conexões na rede'
              "
              [ngClass]="{
                'animate-spin': node.isSearchingPeers,
                'bg-blue-700/30': node.isSearchingPeers,
                'hover:bg-blue-700/30': !node.isSearchingPeers
              }"
              style="vertical-align: middle"
            >
              <svg
                xmlns="http://www.w3.org/2000/svg"
                class="w-4 h-4 text-blue-400 transition-transform"
                [ngClass]="{
                  'animate-spin-slow': node.isSearchingPeers
                }"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor"
                stroke-width="2"
              >
                <circle cx="12" cy="12" r="4" />
                <path d="M2 12a10 10 0 0 1 20 0" />
                <path d="M12 2v2m0 16v2m10-10h-2M4 12H2" />
              </svg>
              <span
                *ngIf="node.isSearchingPeers"
                class="absolute inset-0 rounded-full border-2 border-blue-400 opacity-40 animate-pulse"
              ></span>
            </button>
          </span>
        </div>
        <!-- Direita: Botões de ação -->
        <div class="flex items-center gap-1 ml-auto">
          <button
            class="p-1 rounded text-zinc-400 hover:text-blue-400 hover:bg-zinc-700 transition"
            (click)="editConsensusParams(node)"
            title="Parâmetros de Consenso"
          >
            <svg
              class="w-4 h-4"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"
              />
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"
              />
            </svg>
          </button>
          <button
            class="p-1 rounded text-zinc-400 hover:text-red-400 hover:bg-zinc-700 transition"
            (click)="removeNode(i)"
            title="Remover nó"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              class="h-4 w-4"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"
              />
            </svg>
          </button>
        </div>
      </div>
      <div class="flex flex-col items-center">
        <span class="text-xs text-zinc-400">Status:</span>
        <span
          class="px-2 py-1 rounded text-xs"
          [ngClass]="{
            'bg-blue-900 text-blue-400 animate-pulse': node.isSyncing,
            'bg-zinc-900 text-zinc-400': !node.isSyncing
          }"
        >
          {{ node.isSyncing ? "Sincronizando..." : "Sincronizado" }}
        </span>
      </div>
      <div class="flex flex-col items-center">
        <span class="text-xs text-zinc-400">Blocos:</span>
        <span class="font-mono text-base text-green-400">{{
          node.heights.length || 0
        }}</span>
      </div>
      <!-- Mini-blockchain no corpo do card, antes dos eventos -->
      <div
        class="flex items-center gap-1 my-2 opacity-80 justify-center w-full"
      >
        <ng-container *ngFor="let block of node.lastMainBlocks; let i = index">
          <div class="relative flex flex-col items-center justify-center">
            <div
              class="flex flex-col items-center justify-center w-7 h-7 rounded-md border-2 text-[0.75rem] cursor-pointer transition duration-200 ease-in-out"
              [ngClass]="{
                'bg-blue-700 border-blue-400 text-white':
                  i === node.lastMainBlocks.length - 1,
                'bg-zinc-700 border-zinc-500 text-zinc-200':
                  i !== node.lastMainBlocks.length - 1
              }"
              [title]="
                'Bloco #' +
                block.height +
                '\nHash: ' +
                block.hash +
                '\nMiner: ' +
                (block.minerId ?? '-') +
                '\nTxs: ' +
                block.transactions.length
              "
            >
              <span>{{ block.height }}</span>
              <span
                class="text-[0.65em] -mt-0.5"
                [ngClass]="{
                  'text-green-400 font-bold': block.minerId === node.id,
                  'text-zinc-300': block.minerId !== node.id
                }"
                >M{{ block.minerId ?? "-" }}</span
              >
            </div>
          </div>
          <span *ngIf="i < node.lastMainBlocks.length - 1" class="text-zinc-500"
            >→</span
          >
        </ng-container>
      </div>
      <!-- Seção de peers durante primeira sincronização -->
      <div *ngIf="node.isSyncing" class="w-full mt-4">
        <div class="text-xs text-zinc-400 mb-2">Peers:</div>
        <div class="space-y-2">
          <div
            *ngFor="let peer of node.syncPeers"
            class="flex items-center justify-between text-xs"
          >
            <span class="text-zinc-300">Nó #{{ peer.nodeId }}</span>
            <span
              [ngClass]="{
                'text-yellow-400': peer.status === 'validating',
                'text-green-400': peer.status === 'valid',
                'text-red-400': peer.status === 'invalid',
                'text-zinc-400': peer.status === 'pending'
              }"
            >
              {{ getPeerStatusText(peer) }}
            </span>
          </div>
        </div>
      </div>
      <!-- Log de eventos de propagação/validação de blocos -->
      <app-events
        [node]="node"
        (show)="showLogs()"
        (close)="closeLogs()"
        class="max-h-80 overflow-y-auto w-full"
      ></app-events>
    </div>
  </div>
  <app-consensus-dialog
    *ngIf="showConsensusDialog && consensusNode"
    [miner]="consensusNode"
    (close)="closeConsensusDialog()"
    (versionChange)="closeConsensusDialog()"
  ></app-consensus-dialog>
</div>
