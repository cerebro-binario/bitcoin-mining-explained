<div
  *ngIf="miner"
  class="bg-zinc-800 rounded-lg shadow p-6 border border-zinc-700"
>
  <div class="flex items-center gap-2 mb-4">
    <span class="text-lg font-bold text-blue-400">{{ miner.name }}</span>
    <span class="ml-auto text-xs text-zinc-400">#{{ miner.id }}</span>
    <button
      class="ml-2 p-1 rounded text-zinc-400 hover:text-red-400 hover:bg-zinc-700 transition"
      (click)="removeMiner(miner)"
      title="Remover minerador"
    >
      <svg
        xmlns="http://www.w3.org/2000/svg"
        class="h-4 w-4"
        fill="none"
        viewBox="0 0 24 24"
        stroke="currentColor"
      >
        <path
          stroke-linecap="round"
          stroke-linejoin="round"
          stroke-width="2"
          d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"
        />
      </svg>
    </button>
  </div>

  <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
    <div class="space-y-4">
      <div class="flex items-center gap-2">
        <span class="text-xs text-zinc-400">Hash Rate:</span>
        <div class="flex gap-1">
          <button
            *ngFor="let rate of hashRateOptions"
            class="px-2 py-1 rounded text-xs font-semibold transition"
            [ngClass]="{
              'bg-blue-600 text-white': miner.hashRate === rate.value,
              'bg-zinc-700 text-zinc-300 hover:bg-zinc-600':
                miner.hashRate !== rate.value
            }"
            (click)="setHashRate(rate.value)"
            [title]="rate.label"
          >
            {{ rate.label }}
          </button>
        </div>
      </div>
      <div class="flex items-center gap-2">
        <span class="text-xs text-zinc-400">Endereço:</span>
        <span class="font-mono text-xs text-green-400 break-all">{{
          miner.miningAddress
        }}</span>
      </div>
      <div class="flex items-center gap-2">
        <span class="text-xs text-zinc-400">Assinatura:</span>
        <span class="font-mono text-xs text-green-400">{{ miner.name }}</span>
      </div>

      <div class="flex items-center gap-2 mt-4">
        <button
          *ngIf="!miner.isMining"
          class="px-3 py-1 rounded bg-green-600 text-white text-sm font-semibold hover:bg-green-700 transition"
          (click)="startMining(miner)"
        >
          Iniciar Mineração
        </button>
        <button
          *ngIf="miner.isMining"
          class="px-3 py-1 rounded bg-yellow-600 text-white text-sm font-semibold hover:bg-yellow-700 transition"
          (click)="stopMining(miner)"
        >
          Pausar Mineração
        </button>
        <button
          class="px-3 py-1 rounded bg-blue-600 text-white text-sm font-semibold hover:bg-blue-700 transition"
          (click)="createTransaction(miner)"
        >
          Nova Transação
        </button>
        <span
          class="ml-2 px-2 py-1 rounded text-xs"
          [ngClass]="{
            'bg-green-900 text-green-400': miner.isMining,
            'bg-zinc-900 text-zinc-400': !miner.isMining && !miner.isSyncing,
            'bg-blue-900 text-blue-400 animate-pulse': miner.isSyncing
          }"
        >
          {{
            miner.isMining
              ? "Minerando..."
              : miner.isSyncing
              ? "Sincronizando..."
              : "Parado"
          }}
        </span>
      </div>
    </div>

    <div>
      <app-mining-block
        [block]="miner.currentBlock"
        [miningElapsed]="miner.currentBlock?.miningElapsed"
      ></app-mining-block>
    </div>
  </div>

  <!-- Blockchain Local -->
  <div class="mt-6">
    <div
      class="flex items-center justify-between mb-4 cursor-pointer hover:bg-zinc-700/50 p-2 rounded transition-colors"
      (click)="toggleBlockchainVisibility()"
    >
      <div class="flex items-center gap-2">
        <h3 class="text-lg font-semibold text-blue-400">Blockchain Local</h3>
        <span class="text-xs text-zinc-400">
          {{ miner.heights.length || 0 }} blocos
          <span *ngIf="miner.getLatestBlock()"
            >(Último: #{{ miner.getLatestBlock()?.height }})</span
          >
        </span>
      </div>
      <svg
        xmlns="http://www.w3.org/2000/svg"
        class="h-5 w-5 text-zinc-400 transition-transform"
        [ngClass]="{ 'rotate-180': !isBlockchainVisible }"
        fill="none"
        viewBox="0 0 24 24"
        stroke="currentColor"
      >
        <path
          stroke-linecap="round"
          stroke-linejoin="round"
          stroke-width="2"
          d="M19 9l-7 7-7-7"
        />
      </svg>
    </div>
    <div
      class="overflow-hidden transition-all duration-300 ease-in-out"
      [ngStyle]="{
        'max-height': isBlockchainVisible ? '1000px' : '0px',
        opacity: isBlockchainVisible ? '1' : '0'
      }"
    >
      <div class="relative">
        <div class="overflow-x-auto pb-4">
          <div
            id="miners-panel-container"
            class="flex flex-row gap-16 items-start"
          >
            <!-- Bloco atual -->
            <div
              *ngFor="let nodes of miner.heights; let height = index"
              class="relative height-element"
              @blockAnimation
              [@slideRightAnimation]="{
                value: isMoving ? 'moved' : 'default',
                params: { slideXValue }
              }"
            >
              @let h = miner.heights.length - height - 1;
              <div
                class="relative py-2 flex flex-col gap-4 height-element-container"
              >
                <div
                  *ngFor="let node of nodes"
                  class="relative block-element rounded-lg p-4 border w-64 shadow transition-transform cursor-pointer group flex flex-col"
                  [ngClass]="[
                    getBlockBackgroundColor(node),
                    getBlockBorderColor(node)
                  ]"
                >
                  <div class="flex items-center justify-between mb-1">
                    <span
                      class="font-semibold text-blue-300 text-base flex items-center gap-2"
                    >
                      #{{ h }}
                    </span>
                    <div class="flex items-center gap-2">
                      <span class="text-xs text-zinc-400">{{
                        node.block.timestamp | date : "shortTime"
                      }}</span>
                      <span
                        *ngIf="node.block.miningElapsed"
                        class="text-xs text-zinc-400 bg-zinc-900/50 rounded px-2 py-0.5"
                        >⏱️
                        {{
                          (node.block.miningElapsed / 1000).toFixed(1)
                        }}s</span
                      >
                      <span
                        *ngIf="node.block.minerId"
                        class="text-xs text-blue-400 bg-blue-900/50 rounded px-2 py-0.5"
                        >Miner {{ node.block.minerId }}</span
                      >
                    </div>
                  </div>
                  <div class="border-b border-zinc-700 my-1"></div>
                  <div class="mb-1">
                    <span class="text-zinc-400">Hash:</span>
                    <div class="font-mono text-xs text-zinc-300 break-all">
                      {{ node.block.hash }}
                    </div>
                  </div>
                  <div class="mb-1">
                    <span class="text-zinc-400">Anterior:</span>
                    <div class="font-mono text-xs text-zinc-500 break-all">
                      {{ node.block.previousHash }}
                    </div>
                  </div>
                  <div class="flex items-center justify-between mt-1">
                    <div class="flex items-center gap-1">
                      <span class="text-zinc-400">Txs:</span>
                      <span class="font-mono text-xs text-zinc-300">{{
                        node.block.transactions.length
                      }}</span>
                    </div>
                    <div class="flex items-center gap-1">
                      <span class="text-zinc-400">Nonce:</span>
                      <span class="font-mono text-xs text-zinc-300">{{
                        node.block.nonce
                      }}</span>
                    </div>
                  </div>

                  <!-- Conexões -->
                  @if(node.parent) {
                  <div
                    class="absolute bg-zinc-500 text-xs w-2.5 h-2.5 rounded-lg right-0 top-1/2 -translate-y-1/2 translate-x-1/2 -z-10"
                    [ngStyle]="{
                      'clip-path':
                        'polygon(50% 0%, 100% 0%, 100% 100%, 50% 100%)'
                    }"
                  ></div>
                  <svg
                    class="absolute h-full w-full top-0 right-0 bottom-0 left-0 pointer-events-none overflow-visible -z-50"
                  >
                    <path
                      [attr.d]="getCurvedPath(miner, node, height)"
                      [attr.stroke]="
                        getConnectionStrokeColor(node, isHeightResolved(height))
                      "
                      stroke-width="2"
                      fill="transparent"
                    />
                  </svg>
                  } @if(node.children.length === 0) {
                  <div
                    *ngIf="h !== 0"
                    class="absolute w-3 h-3 -left-6 top-1/2 -translate-y-1/2 -translate-x-1/2 bg-zinc-400"
                  ></div>
                  <div
                    *ngIf="h !== 0"
                    class="absolute w-6 h-0.5 -left-6 top-1/2 -translate-y-1/2 bg-zinc-400"
                  ></div>
                  } @else {
                  <div
                    *ngFor="let child of node.children; let i = index"
                    class="absolute bg-zinc-500 text-xs w-2.5 h-2.5 rounded-lg left-0 -translate-y-1/2 -translate-x-1/2 -z-50"
                    [ngStyle]="{
                      top:
                        'calc(' +
                        getDynamicTopValue(node.children.length, i) +
                        '%)',
                      'clip-path': 'polygon(0% 0%, 50% 0%, 50% 100%, 0% 100%)'
                    }"
                  ></div>
                  }
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
