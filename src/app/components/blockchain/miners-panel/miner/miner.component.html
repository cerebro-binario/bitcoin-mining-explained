<div
  *ngIf="miner"
  class="bg-zinc-800 rounded-lg shadow p-6 border border-zinc-700 space-y-4"
>
  <div class="flex items-center gap-2">
    <span class="text-lg font-bold text-blue-400 flex items-center gap-2">
      {{ miner.name }}
      <span
        class="inline-block w-3 h-3 rounded-full border border-zinc-700"
        [ngClass]="{
          'bg-blue-500 animate-pulse': miner.isSyncing,
          'bg-green-500': !miner.isSyncing
        }"
        [title]="miner.isSyncing ? 'Sincronizando com peers' : 'Conectado'"
      ></span>
    </span>

    <!-- Mining Controls in Header -->
    <ng-container *ngIf="miner">
      <span
        class="ml-2 px-3 py-1 rounded text-xs font-semibold flex items-center justify-center min-w-[110px] transition-colors"
        [ngClass]="{
          'bg-green-900 text-green-400': miner.isMining,
          'bg-zinc-900 text-zinc-400': !miner.isMining
        }"
        [title]="miner.isMining ? 'Minerando' : 'Parado'"
      >
        <ng-container *ngIf="miner.isMining">
          <svg
            class="inline h-3 w-3 mr-1"
            fill="currentColor"
            viewBox="0 0 20 20"
          >
            <path d="M6 4h2v12H6V4zm6 0h2v12h-2V4z" />
          </svg>
          Minerando
        </ng-container>
        <ng-container *ngIf="!miner.isMining">
          <svg
            class="inline h-3 w-3 mr-1"
            fill="currentColor"
            viewBox="0 0 20 20"
          >
            <circle cx="10" cy="10" r="5" />
          </svg>
          Parado
        </ng-container>
      </span>
      <button
        *ngIf="!miner.isMining"
        class="ml-4 px-3 py-1 rounded text-white text-sm font-semibold transition"
        [ngClass]="{
          'bg-green-600 hover:bg-green-700':
            !miner.isSyncing || miner.initialSyncComplete,
          'bg-zinc-600 cursor-not-allowed':
            miner.isSyncing && !miner.initialSyncComplete
        }"
        (click)="startMining(miner)"
        [disabled]="miner.isSyncing && !miner.initialSyncComplete"
        [title]="
          miner.isSyncing && !miner.initialSyncComplete
            ? 'Aguarde o download inicial da blockchain'
            : ''
        "
      >
        {{
          miner.isSyncing && !miner.initialSyncComplete
            ? "Aguardando Sincronização"
            : "Iniciar Mineração"
        }}
      </button>
      <button
        *ngIf="miner.isMining"
        class="ml-4 px-3 py-1 rounded bg-yellow-600 text-white text-sm font-semibold hover:bg-yellow-700 transition"
        (click)="stopMining(miner)"
      >
        Pausar Mineração
      </button>
      <button
        class="ml-2 px-3 py-1 rounded bg-blue-600 text-white text-sm font-semibold hover:bg-blue-700 transition"
        (click)="createTransaction(miner)"
      >
        Nova Transação
      </button>
    </ng-container>

    <div class="flex items-center gap-2 ml-4">
      <span class="text-xs text-zinc-400">Chain:</span>
      <span class="text-xs text-blue-400">{{
        miner.heights.length > 0 ? miner.heights.length - 1 : 0
      }}</span>
      <span class="text-xs text-zinc-400">blocos</span>
      <span *ngIf="miner.getLatestBlock()" class="text-xs text-blue-400"
        >(#{{ miner.getLatestBlock()?.height }})</span
      >
    </div>

    <span class="ml-auto text-xs text-zinc-400">#{{ miner.id }}</span>
    <button
      class="ml-2 p-1 rounded text-zinc-400 hover:text-blue-400 hover:bg-zinc-700 transition"
      (click)="toggleMinerDetailsVisibility()"
      [title]="
        isMinerDetailsVisible ? 'Recolher minerador' : 'Expandir minerador'
      "
    >
      <svg
        xmlns="http://www.w3.org/2000/svg"
        class="h-4 w-4 transition-transform"
        [ngClass]="{ 'rotate-180': isMinerDetailsVisible }"
        fill="none"
        viewBox="0 0 24 24"
        stroke="currentColor"
      >
        <path
          stroke-linecap="round"
          stroke-linejoin="round"
          stroke-width="2"
          d="M19 9l-7 7-7-7"
        />
      </svg>
    </button>
    <button
      class="ml-2 p-1 rounded text-zinc-400 hover:text-red-400 hover:bg-zinc-700 transition"
      (click)="removeMiner(miner)"
      title="Remover minerador"
    >
      <svg
        xmlns="http://www.w3.org/2000/svg"
        class="h-4 w-4"
        fill="none"
        viewBox="0 0 24 24"
        stroke="currentColor"
      >
        <path
          stroke-linecap="round"
          stroke-linejoin="round"
          stroke-width="2"
          d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"
        />
      </svg>
    </button>
  </div>

  <!-- Mini-chain dos últimos 5 blocos -->
  <div
    *ngIf="!isMinerDetailsVisible"
    class="flex items-center gap-2 px-4 py-2"
    style="min-height: 32px"
  >
    <ng-container *ngFor="let block of lastMainBlocks; let i = index">
      <div
        class="flex flex-col items-center justify-center"
        [ngClass]="{
          'bg-blue-700 border-blue-400 text-white':
            i === lastMainBlocks.length - 1,
          'bg-zinc-700 border-zinc-500 text-zinc-200':
            i !== lastMainBlocks.length - 1
        }"
        style="
          width: 32px;
          height: 32px;
          border-radius: 6px;
          border-width: 2px;
          font-size: 0.85rem;
          cursor: pointer;
          transition: background 0.2s, border 0.2s;
        "
        [title]="
          'Bloco #' +
          block.height +
          '\nHash: ' +
          block.hash +
          '\nMiner: ' +
          (block.minerId ?? '-') +
          '\nTxs: ' +
          block.transactions.length
        "
      >
        <span>{{ block.height }}</span>
        <span
          class="text-[0.65em] mt-[-2px]"
          [ngClass]="{
            'text-green-400 font-bold': block.minerId === miner.id,
            'text-zinc-300': block.minerId !== miner.id
          }"
          >M{{ block.minerId ?? "-" }}</span
        >
      </div>
      <span *ngIf="i < lastMainBlocks.length - 1" class="text-zinc-500">→</span>
    </ng-container>
  </div>

  <div
    class="overflow-hidden transition-all duration-300 ease-in-out"
    [ngStyle]="{
      'max-height': !isMinerDetailsVisible ? '0px' : null,
      opacity: isMinerDetailsVisible ? '1' : '0'
    }"
  >
    <div class="space-y-5">
      <div class="flex items-center gap-2">
        <span class="text-xs text-zinc-400">Endereço:</span>
        <span class="font-mono text-xs text-green-400 break-all">{{
          miner.miningAddress
        }}</span>
      </div>
      <div class="flex items-center gap-2">
        <span class="text-xs text-zinc-400">Assinatura:</span>
        <span class="font-mono text-xs text-green-400">{{ miner.name }}</span>
      </div>

      <!-- Hash Rate Minimalista (agora realmente fora do header) -->
      <div class="flex items-center gap-2">
        <span class="text-xs text-zinc-400">Hash Rate:</span>
        <div class="flex justify-between items-center gap-1">
          <ng-container *ngFor="let rate of hashRateOptions">
            <button
              class="px-2 py-1 rounded border text-xs font-semibold transition min-w-[3.5rem]"
              [ngClass]="{
                'border-blue-500 bg-blue-600/10 text-blue-400 font-bold':
                  miner.hashRate === rate.value,
                'border-zinc-600 bg-transparent text-zinc-300 hover:border-blue-400 hover:text-blue-300':
                  miner.hashRate !== rate.value
              }"
              (click)="setHashRate(rate.value)"
              [title]="rate.label"
            >
              {{ rate.label }}
            </button>
          </ng-container>
        </div>
        <span *ngIf="miner.isMining" class="text-xs text-green-400 ml-2">
          (Real: {{ miner.currentHashRate }} H/s)
        </span>
      </div>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-6">
      <div
        class="relative overflow-hidden bg-zinc-900 border border-zinc-800 rounded-lg p-4 flex flex-col"
      >
        <div class="font-semibold text-blue-400 mb-2 flex items-center gap-2">
          <span>Eventos</span>
          <span class="text-xs text-zinc-400"
            >({{ miner.eventLog.length }})</span
          >
        </div>
        <ul class="space-y-1 text-xs pr-1">
          <li
            *ngFor="let event of miner.eventLog | slice : 0 : 15"
            [ngClass]="{
              'text-green-400': event.type === 'block-validated',
              'text-red-400': event.type === 'block-rejected',
              'text-blue-400': event.type === 'block-received'
            }"
          >
            <span class="font-mono">{{
              event.timestamp | date : "shortTime"
            }}</span>
            <span *ngIf="event.type === 'block-validated'">✔️</span>
            <span *ngIf="event.type === 'block-rejected'">❌</span>
            <span *ngIf="event.type === 'block-received'">⬇️</span>
            <span class="ml-1">{{ event.type.replace("block-", "") }}</span>
            <span class="ml-1 text-zinc-400"
              >({{ event.blockHash | slice : 0 : 8 }}...)</span
            >
            <span *ngIf="event.reason" class="ml-1 text-red-300"
              >({{ event.reason }})</span
            >
          </li>
          <li *ngIf="miner.eventLog.length === 0" class="text-zinc-500 italic">
            Nenhum evento ainda.
          </li>
        </ul>
        <!-- Fade e botão -->
        <div
          *ngIf="miner.eventLog.length > 8"
          class="absolute left-0 right-0 bottom-0 h-1/4 pointer-events-none"
          style="
            background: linear-gradient(to top, #18181b 15%, transparent 80%);
          "
        ></div>
        <button
          *ngIf="miner.eventLog.length > 8"
          (click)="showAllLogs = true"
          class="absolute right-3 bottom-3 z-10 px-2 py-1 text-xs rounded bg-blue-700 text-white font-semibold shadow hover:bg-blue-800 transition pointer-events-auto"
          style="backdrop-filter: blur(2px)"
        >
          Ver tudo
        </button>
      </div>

      <app-mining-block
        [block]="miner.currentBlock"
        [miningElapsed]="miner.currentBlock?.miningElapsed"
      ></app-mining-block>
    </div>

    <!-- Blockchain Local -->
    <div class="mt-6">
      <div
        class="flex items-center justify-between mb-4 cursor-pointer hover:bg-zinc-700/50 p-2 rounded transition-colors"
        (click)="toggleBlockchainVisibility()"
      >
        <div class="flex items-center gap-2">
          <h3 class="text-lg font-semibold text-blue-400">Blockchain Local</h3>
          <span class="text-xs text-zinc-400">
            {{ miner.heights.length > 0 ? miner.heights.length - 1 : 0 }} blocos
            <span *ngIf="miner.getLatestBlock()"
              >(Último: #{{ miner.getLatestBlock()?.height }})</span
            >
          </span>
        </div>
        <div class="flex items-center gap-2">
          <span class="text-xs text-zinc-400">{{
            isBlockchainVisible ? "Recolher" : "Expandir"
          }}</span>
          <svg
            xmlns="http://www.w3.org/2000/svg"
            class="h-5 w-5 text-zinc-400 transition-transform"
            [ngClass]="{ 'rotate-180': isBlockchainVisible }"
            fill="none"
            viewBox="0 0 24 24"
            stroke="currentColor"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M19 9l-7 7-7-7"
            />
          </svg>
        </div>
      </div>
      <div
        class="overflow-hidden transition-all duration-300 ease-in-out"
        [ngStyle]="{
          'max-height': !isBlockchainVisible ? '0px' : null,
          opacity: isBlockchainVisible ? '1' : '0'
        }"
      >
        <div class="relative">
          <div class="overflow-x-auto pb-4">
            <div
              id="miners-panel-container"
              class="flex flex-row gap-16 items-stretch"
            >
              <!-- Bloco atual -->
              <ng-container
                *ngFor="let nodes of miner.heights; let height = index"
              >
                @if(nodes[0].block.height === -1) { @let nChains =
                nodes[0].children.length;
                <div
                  class="relative flex flex-col"
                  @blockAnimation
                  [@slideRightAnimation]="{
                    value: isMoving ? 'moved' : 'default',
                    params: { slideXValue }
                  }"
                >
                  <div
                    *ngIf="nChains > 1"
                    [id]="'originBlock-' + miner.id"
                    class="w-5 h-5 bg-zinc-500 rounded-full"
                    [ngStyle]="{
                        transform: getOriginBlockTransform(nChains),
                      }"
                  ></div>
                </div>
                } @else { @let h = miner.getHeightIndex(height);
                <div
                  class="relative height-element"
                  @blockAnimation
                  [@slideRightAnimation]="{
                    value: isMoving ? 'moved' : 'default',
                    params: { slideXValue }
                  }"
                >
                  <div
                    class="relative py-2 flex flex-col gap-4 height-element-container"
                  >
                    <div
                      *ngFor="let node of nodes"
                      class="relative block-element rounded-lg p-4 border w-72 shadow transition-transform cursor-pointer group flex flex-col"
                      [ngClass]="[
                        getBlockBackgroundColor(node),
                        getBlockBorderColor(node)
                      ]"
                    >
                      <div class="flex items-center justify-between mb-1">
                        <div class="flex items-center gap-2">
                          <span
                            class="font-semibold text-blue-300 text-base flex items-center gap-2"
                          >
                            #{{ h }}
                          </span>
                          <span class="text-xs text-zinc-400">{{
                            node.block.timestamp | date : "shortTime"
                          }}</span>
                        </div>
                        <div class="flex items-center gap-2">
                          <span
                            *ngIf="node.block.miningElapsed"
                            class="text-xs text-zinc-400 bg-zinc-900/50 rounded px-2 py-0.5"
                            >⏱️
                            {{
                              (node.block.miningElapsed / 1000).toFixed(1)
                            }}s</span
                          >
                          <span
                            *ngIf="node.block.minerId"
                            class="text-xs text-blue-400 bg-blue-900/50 rounded px-2 py-0.5"
                            >Miner {{ node.block.minerId }}</span
                          >
                        </div>
                      </div>
                      <div class="border-b border-zinc-700 my-1"></div>
                      <div class="mb-1">
                        <span class="text-zinc-400">Hash:</span>
                        <div class="font-mono text-xs text-zinc-300 break-all">
                          {{ node.block.hash }}
                        </div>
                      </div>
                      <div class="mb-1">
                        <span class="text-zinc-400">Anterior:</span>
                        <div class="font-mono text-xs text-zinc-500 break-all">
                          {{ node.block.previousHash }}
                        </div>
                      </div>
                      <div class="flex items-center justify-between mt-1">
                        <div class="flex items-center gap-1">
                          <span class="text-zinc-400">Txs:</span>
                          <span class="font-mono text-xs text-zinc-300">{{
                            node.block.transactions.length
                          }}</span>
                        </div>
                        <div class="flex items-center gap-1">
                          <span class="text-zinc-400">Nonce:</span>
                          <span class="font-mono text-xs text-zinc-300">{{
                            node.block.nonce
                          }}</span>
                        </div>
                      </div>

                      <!-- Conexões -->
                      @if(node.parent) {
                      <div
                        class="absolute bg-zinc-500 text-xs w-2.5 h-2.5 rounded-lg right-0 top-1/2 -translate-y-1/2 translate-x-1/2 z-10"
                        [ngStyle]="{
                          'clip-path':
                            'polygon(50% 0%, 100% 0%, 100% 100%, 50% 100%)'
                        }"
                      ></div>
                      <svg
                        *ngIf="
                          node.parent.block.height !== -1 ||
                          node.parent.children.length > 1
                        "
                        class="absolute h-full w-full top-0 right-0 bottom-0 left-0 pointer-events-none overflow-visible"
                      >
                        <path
                          [attr.d]="getCurvedPath(miner, node, height)"
                          [attr.stroke]="
                            getConnectionStrokeColor(
                              node,
                              isHeightResolved(height)
                            )
                          "
                          stroke-width="2"
                          fill="transparent"
                        />
                      </svg>
                      } @if(node.children.length === 0) {
                      <div
                        class="absolute w-3 h-3 -left-6 top-1/2 -translate-y-1/2 -translate-x-1/2 bg-zinc-400"
                      ></div>
                      <div
                        class="absolute w-6 h-0.5 -left-6 top-1/2 -translate-y-1/2 bg-zinc-400"
                      ></div>
                      } @else {
                      <div
                        *ngFor="let child of node.children; let i = index"
                        class="absolute bg-zinc-500 text-xs w-2.5 h-2.5 rounded-lg left-0 -translate-y-1/2 -translate-x-1/2 z-10"
                        [ngStyle]="{
                          top:
                            'calc(' +
                            getDynamicTopValue(node.children.length, i) +
                            '%)',
                          'clip-path':
                            'polygon(0% 0%, 50% 0%, 50% 100%, 0% 100%)'
                        }"
                      ></div>
                      }
                    </div>
                  </div>
                </div>
                }
              </ng-container>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Dialog de todos os logs -->
  <ng-template [ngIf]="showAllLogs">
    <div
      class="fixed inset-0 bg-black/60 flex items-center justify-center z-50"
    >
      <div
        class="bg-zinc-900 border border-zinc-800 rounded-lg p-6 w-full max-w-lg max-h-[80vh] flex flex-col shadow-xl"
      >
        <div class="flex items-center justify-between mb-4">
          <span class="font-semibold text-blue-400">Todos os Eventos</span>
          <button
            (click)="showAllLogs = false"
            class="text-zinc-400 hover:text-red-400 text-xl"
          >
            &times;
          </button>
        </div>
        <ul class="flex-1 overflow-y-auto space-y-1 text-xs pr-1">
          <li
            *ngFor="let event of miner.eventLog"
            [ngClass]="{
              'text-green-400': event.type === 'block-validated',
              'text-red-400': event.type === 'block-rejected',
              'text-blue-400': event.type === 'block-received'
            }"
          >
            <span class="font-mono">{{
              event.timestamp | date : "shortTime"
            }}</span>
            <span *ngIf="event.type === 'block-validated'">✔️</span>
            <span *ngIf="event.type === 'block-rejected'">❌</span>
            <span *ngIf="event.type === 'block-received'">⬇️</span>
            <span class="ml-1">{{ event.type.replace("block-", "") }}</span>
            <span class="ml-1 text-zinc-400"
              >({{ event.blockHash | slice : 0 : 8 }}...)</span
            >
            <span *ngIf="event.reason" class="ml-1 text-red-300"
              >({{ event.reason }})</span
            >
          </li>
        </ul>
      </div>
    </div>
  </ng-template>
</div>
