<p-card header="Analogia dos Dados" class="mb-6 shadow-lg w-full">
  <div class="my-5 pb-5 border-b">
    <p>
      No Desafio do Dado, vence quem lan√ßar um n√∫mero igual ou menor que o
      valor-alvo (target).
    </p>
    <p>
      Qualquer pessoa pode participar a qualquer momento e com qualquer
      quantidade de dados.
    </p>
    <p>
      Obviamente, o jogador que participar com mais dados ter√° mais chances de
      acertar o valor-alvo primeiro e, portanto, mais chances de ganhar o
      desafio.
    </p>
    <p>
      Quanto menor o alvo, mais dif√≠cil √© ganhar, pois h√° menos resultados
      poss√≠veis que atendem √† condi√ß√£o.
    </p>
    <p>
      Isso torna o jogo mais desafiador e exige mais tentativas para vencer.
    </p>
  </div>

  <h3 class="font-bold text-lg mb-5">O desafio:</h3>
  <div class="flex flex-col gap-3 items-start w-full">
    <!-- Bot√µes de a√ß√£o -->
    <div class="action-buttons">
      <p-button
        label="Adicionar Competidor"
        icon="pi pi-plus"
        (onClick)="addCompetitor()"
      ></p-button>
    </div>

    <p-table [value]="competitors" class="p-datatable-sm w-full rounded-md">
      <ng-template #header>
        <tr>
          <th style="width: 5%"></th>
          <th style="width: 15%">Nome</th>
          <th>Dados</th>
        </tr>
      </ng-template>
      <ng-template #body let-competitor>
        <tr>
          <td>
            <p-button
              icon="pi pi-trash"
              severity="danger"
              [rounded]="true"
              [text]="true"
              (onClick)="removeCompetitor(competitor.id)"
            ></p-button>
          </td>
          <td>{{ competitor.name }}</td>
          <td>
            <div class="flex flex-wrap gap-5 items-center">
              <div class="flex flex-col gap-2">
                <p-button
                  icon="pi pi-plus"
                  severity="secondary"
                  (onClick)="increaseDice(competitor)"
                />
                <p-button
                  icon="pi pi-minus"
                  severity="secondary"
                  (onClick)="decreaseDice(competitor)"
                />
              </div>
              <app-dice
                *ngFor="let dice of competitor.dices"
                [dice]="dice"
                [target]="target"
                [maxValue]="maxTarget"
                [animationDuration]="rollAnimationDuration"
              ></app-dice>
            </div>
          </td>
        </tr>
      </ng-template>
    </p-table>

    <div class="bg-gray-900 text-white p-6 rounded-lg shadow-lg w-full mx-auto">
      <!-- Controle da Competi√ß√£o -->
      <div class="flex justify-between items-center">
        <h2 class="text-lg font-bold">Controle da Competi√ß√£o</h2>
        <button
          pButton
          label="Editar Par√¢metros"
          icon="pi pi-cog"
          (click)="isEditing = true"
        ></button>
      </div>

      <div class="flex gap-4 mt-4">
        <p-button
          label="{{ isMining ? 'Pausar Competi√ß√£o' : 'Iniciar Competi√ß√£o' }}"
          (click)="toggleCompetition()"
          [severity]="isMining ? 'danger' : 'success'"
          [icon]="isMining ? 'pi pi-pause' : 'pi pi-play'"
        />
        <p-button
          [disabled]="isMining"
          label="Pr√≥xima rodada"
          (click)="startCompetition(1)"
          severity="secondary"
          icon="pi pi-step-forward"
        ></p-button>
      </div>

      <!-- Par√¢metros da Simula√ß√£o -->
      <div class="mt-4 p-4 border border-gray-700 rounded-md">
        <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
          <div class="flex flex-col">
            <span class="text-sm text-gray-400">üéØ Target</span>
            <span class="font-semibold text-lg">{{ target }}</span>
          </div>

          <div class="flex flex-col">
            <span class="text-sm text-gray-400">üéØ Target M√°ximo</span>
            <span class="font-semibold text-lg">{{ maxTarget }}</span>
          </div>

          <div class="flex flex-col">
            <span class="text-sm text-gray-400"
              >‚è≥ Intervalo entre Lan√ßamentos</span
            >
            <span class="font-semibold text-lg">{{ miningInterval }}s</span>
          </div>

          <div class="flex flex-col">
            <span class="text-sm text-gray-400">üîÑ Blocos para Reajuste</span>
            <span class="font-semibold text-lg">{{ nBlocksToAdjust }}</span>
          </div>

          <div class="flex flex-col">
            <span class="text-sm text-gray-400">‚è± Tempo M√©dio por Bloco</span>
            <span class="font-semibold text-lg">{{ miningTimeSeconds }}s</span>
          </div>

          <div class="flex flex-col">
            <span class="text-sm text-gray-400">üö¶ Parar Automaticamente</span>
            <span class="font-semibold text-lg">{{
              autoPause ? "Sim" : "N√£o"
            }}</span>
          </div>
        </div>
      </div>

      <hr class="border-gray-700 my-4" />

      <h3 class="text-lg font-bold">Hist√≥rico de Blocos</h3>
    </div>

    <!-- Modal para Edi√ß√£o dos Par√¢metros -->
    <p-dialog
      [(visible)]="isEditing"
      header="Editar Par√¢metros"
      [modal]="true"
      [closable]="true"
    >
      <div class="flex flex-col gap-4">
        <div class="flex items-center justify-between gap-2">
          <label for="target">üéØ Target</label>
          <p-inputnumber
            inputId="target"
            [(ngModel)]="target"
            inputStyleClass="p-inputtext"
          />
        </div>

        <div class="flex items-center justify-between gap-2">
          <label for="maxTarget">üéØ Target M√°ximo</label>
          <p-inputnumber
            inputId="maxTarget"
            [(ngModel)]="maxTarget"
            inputStyleClass="p-inputtext"
          />
        </div>

        <div class="flex items-center justify-between gap-2">
          <label for="miningInterval">‚è≥ Intervalo (s)</label>

          <p-selectbutton
            [options]="[
              { name: '0s', value: 0 },
              { name: '0.5s', value: 0.5 },
              { name: '1s', value: 1 },
              { name: '2s', value: 2 }
            ]"
            [(ngModel)]="miningInterval"
            optionLabel="name"
            optionValue="value"
          />
        </div>

        <div class="flex items-center justify-between gap-2">
          <label for="nBlocksToReadjust">üîÑ Blocos para Reajuste</label>
          <p-inputnumber
            inputId="nBlocksToReadjust"
            [(ngModel)]="nBlocksToAdjust"
            inputStyleClass="p-inputtext"
          />
        </div>

        <div class="flex items-center justify-between gap-2">
          <label for="miningTimeSeconds">‚è± Tempo M√©dio (s)</label>
          <p-selectbutton
            [options]="[
              { name: '1s', value: 1 },
              { name: '10s', value: 10 },
              { name: '100s', value: 100 }
            ]"
            [(ngModel)]="miningTimeSeconds"
            optionLabel="name"
            optionValue="value"
          />
        </div>

        <div class="flex items-center justify-between gap-2">
          <label>üö¶ Parar Automaticamente</label>
          <p-checkbox [(ngModel)]="autoPause" binary="true"></p-checkbox>
        </div>
      </div>

      <ng-template #footer>
        <button
          pButton
          label="Salvar"
          icon="pi pi-check"
          class="p-button-primary"
          (click)="saveParameters()"
        ></button>
      </ng-template>
    </p-dialog>

    <div class="flex flex-col gap-5 w-full">
      <h3 class="font-bold text-lg mb-3">Hist√≥rico de Blocos</h3>
      <div
        id="blockchain"
        class="flex gap-20 relative overflow-x-auto whitespace-nowrap w-full h-auto"
      >
        <!-- Blocos de vencedores -->
        <div
          *ngFor="let blocks of chain.heights; let height = index"
          class="height-element relative flex"
          @blockAnimation
          [@slideRightAnimation]="{
            value: isMoving ? 'moved' : 'default',
            params: { slideXValue }
          }"
        >
          <!-- Criamos a vari√°vel `isResolved` para armazenar o resultado -->
          @let isResolved = isHeightResolved(height);

          <!-- Bloco individual ou m√∫ltiplo -->
          <div class="height-element-container flex flex-col gap-5">
            <div class="p-4 rounded-lg shadow-md text-center w-40">
              #{{ chain.heights.length - height }}
            </div>
            <div
              *ngFor="let block of blocks; trackBy: trackBlocksByFn"
              class="block-element relative flex flex-col p-4 bg-blue-500 text-white rounded-lg shadow-md justify-center items-center min-w-40 h-20 transition-colors duration-500"
              [ngClass]="{
                'bg-green-500': isResolved,
                'bg-red-500': block.isDeadFork
              }"
            >
              <span class="font-bold">{{ block.winner.name }}</span>
              <span>{{ block.timestamp | date : "dd/MM/yyyy HH:mm:ss" }}</span>
              <!-- √çcone de status no canto superior direito -->
              @let statusIcon = getBlockStatusIcon(height); @if (statusIcon !==
              null && !block.isDeadFork) {
              <i
                class="absolute top-1 right-1 text-lg"
                [class]="statusIcon.icon"
                [ngClass]="statusIcon.color"
                pTooltip="{{ statusIcon.tooltip }}"
                tooltipPosition="top"
              ></i>
              } @if(block.previous) {

              <div
                class="absolute text-xs bg-blue-500 w-2.5 h-2.5 rounded-lg right-0 top-1/2 -translate-y-1/2 translate-x-1/2 -z-50"
                [ngClass]="{
                  'bg-green-500': isResolved,
                  'bg-red-500': block.isDeadFork
                }"
              ></div>
              <svg
                class="absolute h-full w-full top-0 right-0 bottom-0 left-0 pointer-events-none overflow-visible"
              >
                <path
                  [attr.d]="getCurvedPath(block, height)"
                  [attr.stroke]="getConnectionStrokeColor(block, isResolved)"
                  stroke-width="2"
                  fill="transparent"
                />
              </svg>
              } @if(block.next.length === 0) {
              <div
                *ngIf="height !== 0"
                class="absolute w-3 h-3 -left-6 top-1/2 -translate-y-1/2 -translate-x-1/2 bg-red-500"
              ></div>
              <div
                *ngIf="height !== 0"
                class="absolute w-6 h-0.5 -left-6 top-1/2 -translate-y-1/2 bg-red-500"
              ></div>
              } @else {
              <div
                *ngFor="let n of block.next; let i = index"
                class="absolute text-xs bg-blue-500 w-2.5 h-2.5 rounded-lg left-0 -translate-y-1/2 -translate-x-1/2 -z-50"
                [ngClass]="{
                  'bg-green-500': isHeightResolved(height - 1),
                  'bg-red-500': n.isDeadFork
                }"
                [ngStyle]="{
                  top: 'calc(' + getDynamicTopValue(block.next.length, i) + '%)'
                }"
              ></div>
              }
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</p-card>
