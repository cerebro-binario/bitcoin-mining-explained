<p-card header="Analogia dos Dados" class="mb-6 shadow-lg w-full">
  <div class="my-5 pb-5 border-b">
    <p>
      No Desafio do Dado, vence quem lançar um número igual ou menor que o
      valor-alvo (target).
    </p>
    <p>
      Qualquer pessoa pode participar a qualquer momento e com qualquer
      quantidade de dados.
    </p>
    <p>
      Obviamente, o jogador que participar com mais dados terá mais chances de
      acertar o valor-alvo primeiro e, portanto, mais chances de ganhar o
      desafio.
    </p>
    <p>
      Quanto menor o alvo, mais difícil é ganhar, pois há menos resultados
      possíveis que atendem à condição.
    </p>
    <p>
      Isso torna o jogo mais desafiador e exige mais tentativas para vencer.
    </p>
  </div>

  <h3 class="font-bold text-lg mb-5">O desafio:</h3>
  <div class="flex flex-col gap-3 items-start w-full">
    <!-- Botões de ação -->
    <div class="action-buttons">
      <p-button
        label="Adicionar Competidor"
        icon="pi pi-plus"
        (onClick)="addCompetitor()"
      ></p-button>
    </div>

    <p-table [value]="competitors" class="p-datatable-sm w-full rounded-md">
      <ng-template #header>
        <tr>
          <th style="width: 5%"></th>
          <th style="width: 15%">Nome</th>
          <th>Dados</th>
        </tr>
      </ng-template>
      <ng-template #body let-competitor>
        <tr>
          <td>
            <p-button
              icon="pi pi-trash"
              severity="danger"
              [rounded]="true"
              [text]="true"
              (onClick)="removeCompetitor(competitor.id)"
            ></p-button>
          </td>
          <td>{{ competitor.name }}</td>
          <td>
            <div class="flex flex-wrap gap-5 items-center">
              <div class="flex flex-col gap-2">
                <p-button
                  icon="pi pi-plus"
                  severity="secondary"
                  (onClick)="increaseDice(competitor)"
                />
                <p-button
                  icon="pi pi-minus"
                  severity="secondary"
                  (onClick)="decreaseDice(competitor)"
                />
              </div>
              <app-dice
                *ngFor="let dice of competitor.dices"
                [dice]="dice"
                [target]="target"
                [maxValue]="maxTarget"
                [animationDuration]="rollAnimationDuration"
              ></app-dice>
            </div>
          </td>
        </tr>
      </ng-template>
    </p-table>

    <div class="bg-gray-900 text-white p-6 rounded-lg shadow-lg w-full mx-auto">
      <!-- Controle da Competição -->
      <div class="flex justify-between items-center">
        <h2 class="text-lg font-bold">Controle da Competição</h2>
        <button
          pButton
          label="Editar Parâmetros"
          icon="pi pi-cog"
          (click)="isEditing = true"
        ></button>
      </div>

      <!-- Parâmetros da Simulação -->
      <div class="mt-4 p-4 border border-gray-700 rounded-md">
        <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
          <div class="flex flex-col">
            <span class="text-sm text-gray-400">Target</span>
            <span class="font-semibold text-lg">{{ target }}</span>
          </div>

          <div class="flex flex-col">
            <span class="text-sm text-gray-400">Target Máximo</span>
            <span class="font-semibold text-lg">{{ maxTarget }}</span>
          </div>

          <div class="flex flex-col">
            <span class="text-sm text-gray-400"
              >Intervalo entre Lançamentos</span
            >
            <span class="font-semibold text-lg">{{ miningInterval }}s</span>
          </div>

          <div class="flex flex-col">
            <span class="text-sm text-gray-400">Blocos para Reajuste</span>
            <span class="font-semibold text-lg">{{ nBlocksToAdjust }}</span>
          </div>

          <div class="flex flex-col">
            <span class="text-sm text-gray-400"
              >Tempo Médio Desejado por Bloco</span
            >
            <span class="font-semibold text-lg">{{ miningTimeSeconds }}s</span>
          </div>

          <div class="flex flex-col">
            <span class="text-sm text-gray-400">Parar Automaticamente</span>
            <span class="font-semibold text-lg">{{
              getAutoPauseModeLabel()
            }}</span>
          </div>
        </div>
      </div>

      <div class="flex gap-4 mt-4">
        <p-button
          label="{{ isMining ? 'Pausar Competição' : 'Iniciar Competição' }}"
          (click)="toggleCompetition()"
          [severity]="isMining ? 'danger' : 'success'"
          [icon]="isMining ? 'pi pi-pause' : 'pi pi-play'"
        />
        <p-button
          [disabled]="isMining"
          label="Próxima rodada"
          (click)="playCompetition(1)"
          severity="secondary"
          icon="pi pi-step-forward"
        ></p-button>
      </div>

      <hr class="border-gray-700 my-4" />

      <div class="flex items-center justify-between mb-4">
        <h2 class="text-xl font-semibold">Histórico de Blocos</h2>

        <div class="flex items-center gap-4 bg-slate-800 rounded-lg px-4 py-2">
          <!-- Época atual -->
          <div class="flex items-center gap-2">
            <i class="pi pi-history text-blue-500"></i>
            <div class="flex flex-col">
              <span class="text-xs text-slate-400">Época</span>
              <span class="font-mono text-sm">{{
                formatOrdinal(getCurrentEpoch())
              }}</span>
            </div>
          </div>

          <!-- Tempo do bloco atual -->
          <div class="flex items-center gap-2">
            <i class="pi pi-clock text-blue-500"></i>
            <div class="flex flex-col">
              <span class="text-xs text-slate-400">Tempo atual</span>
              <span class="font-mono text-sm">{{
                currentMiningTime > 0
                  ? formatMiningTime(currentMiningTime)
                  : "-"
              }}</span>
            </div>
          </div>

          <!-- Tempo médio -->
          <div class="flex items-center gap-2">
            <i class="pi pi-chart-line text-blue-500"></i>
            <div class="flex flex-col">
              <span class="text-xs text-slate-400">Tempo médio</span>
              <span class="font-mono text-sm">{{
                chain.heights.length > 0 && realMiningTimeSeconds
                  ? formatMiningTime(realMiningTimeSeconds * 1000)
                  : "-"
              }}</span>
            </div>
          </div>

          <!-- Variação de Dificuldade -->
          <div class="flex items-center gap-2">
            <i class="pi pi-sliders-h text-blue-500"></i>
            <div class="flex flex-col">
              <span class="text-xs text-slate-400"
                >Probabilidade de Acerto</span
              >
              <div class="flex items-center gap-1.5">
                <span class="font-mono text-sm" [@difficultyChange]="target">
                  {{ getDifficultyAsPercentage().toFixed(1) }}%
                </span>
                <ng-container *ngIf="getDifficultyVariation().value > 0">
                  <div
                    [class]="
                      getDifficultyVariation().increased
                        ? 'text-red-500 bg-red-500/10'
                        : 'text-emerald-500 bg-emerald-500/10'
                    "
                    class="flex items-center gap-0.5 text-xs px-1.5 py-0.5 rounded-full"
                  >
                    <i
                      [class]="
                        'pi ' +
                        (getDifficultyVariation().increased
                          ? 'pi-arrow-down'
                          : 'pi-arrow-up')
                      "
                    ></i>
                    <span class="font-medium"
                      >{{ getDifficultyVariation().value.toFixed(1) }}%</span
                    >
                  </div>
                </ng-container>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div
        id="blockchain"
        class="flex gap-20 relative overflow-x-auto whitespace-nowrap w-full h-auto"
      >
        <!-- Blocos de vencedores -->
        <div
          *ngFor="let blocks of chain.heights; let height = index"
          class="height-element relative flex"
          @blockAnimation
          [@slideRightAnimation]="{
            value: isMoving ? 'moved' : 'default',
            params: { slideXValue }
          }"
        >
          <!-- Criamos a variável `isResolved` para armazenar o resultado -->
          @let isResolved = isHeightResolved(height); @let h =
          chain.heights.length - height;

          <!-- Separador vertical de época -->
          <div *ngIf="h === 1" class="flex flex-col absolute -right-10 h-full">
            <!-- Linha vertical gradiente -->
            <div
              class="absolute h-full w-[2px] bg-gradient-to-b from-transparent via-blue-500/50 to-transparent"
            ></div>

            <!-- Badge da época -->
            <div
              class="absolute z-10 px-3 py-1 rounded-full bg-slate-800/90 border border-blue-500/30 backdrop-blur-sm flex items-center gap-2 shadow-lg transform -translate-x-1/2"
            >
              <i class="pi pi-history text-blue-500 text-sm"></i>
              <span class="text-sm font-medium text-slate-300">
                {{ formatOrdinal(getCurrentEpoch()) }}
                Época
              </span>
            </div>
          </div>

          <div
            *ngIf="h % nBlocksToAdjust === 0"
            class="flex flex-col absolute -left-10 h-full"
          >
            <!-- Linha vertical gradiente -->
            <div
              class="absolute h-full w-[2px] bg-gradient-to-b from-transparent via-blue-500/50 to-transparent"
            ></div>

            <!-- Badge da época -->
            <div
              class="absolute z-10 px-3 py-1 rounded-full bg-slate-800/90 border border-blue-500/30 backdrop-blur-sm flex items-center gap-2 shadow-lg transform -translate-x-1/2"
            >
              <i class="pi pi-history text-blue-500 text-sm"></i>
              <span class="text-sm font-medium text-slate-300">
                {{ formatOrdinal(getCurrentEpoch()) }}
                Época
              </span>
            </div>
          </div>

          <!-- Bloco individual ou múltiplo -->
          <div class="height-element-container flex flex-col gap-5">
            <div class="p-4 rounded-lg shadow-md text-center w-40">
              #{{ chain.heights.length - height }}
            </div>
            <div
              *ngFor="let block of blocks; trackBy: trackBlocksByFn"
              class="block-element relative flex flex-col p-4 bg-blue-500 text-white rounded-lg shadow-md justify-center items-center min-w-40 h-20 transition-colors duration-500"
              [ngClass]="{
                'bg-green-500': isResolved,
                'bg-red-500': block.isDeadFork
              }"
            >
              <span class="font-bold">{{ block.winner.name }}</span>
              <span>{{ block.timestamp | date : "dd/MM/yyyy HH:mm:ss" }}</span>
              <!-- Ícone de status no canto superior direito -->
              @let statusIcon = getBlockStatusIcon(height); @if (statusIcon !==
              null && !block.isDeadFork) {
              <i
                class="absolute top-1 right-1 text-lg"
                [class]="statusIcon.icon"
                [ngClass]="statusIcon.color"
                pTooltip="{{ statusIcon.tooltip }}"
                tooltipPosition="top"
              ></i>
              } @if(block.previous) {

              <div
                class="absolute text-xs bg-blue-500 w-2.5 h-2.5 rounded-lg right-0 top-1/2 -translate-y-1/2 translate-x-1/2 -z-50"
                [ngClass]="{
                  'bg-green-500': isResolved,
                  'bg-red-500': block.isDeadFork
                }"
              ></div>
              <svg
                class="absolute h-full w-full top-0 right-0 bottom-0 left-0 pointer-events-none overflow-visible"
              >
                <path
                  [attr.d]="getCurvedPath(block, height)"
                  [attr.stroke]="getConnectionStrokeColor(block, isResolved)"
                  stroke-width="2"
                  fill="transparent"
                />
              </svg>
              } @if(block.next.length === 0) {
              <div
                *ngIf="height !== 0"
                class="absolute w-3 h-3 -left-6 top-1/2 -translate-y-1/2 -translate-x-1/2 bg-red-500"
              ></div>
              <div
                *ngIf="height !== 0"
                class="absolute w-6 h-0.5 -left-6 top-1/2 -translate-y-1/2 bg-red-500"
              ></div>
              } @else {
              <div
                *ngFor="let n of block.next; let i = index"
                class="absolute text-xs bg-blue-500 w-2.5 h-2.5 rounded-lg left-0 -translate-y-1/2 -translate-x-1/2 -z-50"
                [ngClass]="{
                  'bg-green-500': isHeightResolved(height - 1),
                  'bg-red-500': n.isDeadFork
                }"
                [ngStyle]="{
                  top: 'calc(' + getDynamicTopValue(block.next.length, i) + '%)'
                }"
              ></div>
              }
              <div class="flex items-center gap-2 text-xs">
                <i class="pi pi-stopwatch"></i>
                <span class="font-mono">{{
                  formatMiningTime(block.miningTime)
                }}</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal para Edição dos Parâmetros -->
    <p-dialog
      [(visible)]="isEditing"
      header="Editar Parâmetros"
      [modal]="true"
      [closable]="true"
    >
      <div class="flex flex-col gap-4">
        <div class="flex items-center justify-between gap-2">
          <label for="target">Target</label>
          <p-inputnumber
            inputId="target"
            [(ngModel)]="target"
            inputStyleClass="p-inputtext"
          />
        </div>

        <div class="flex items-center justify-between gap-2">
          <label for="maxTarget">Target Máximo</label>
          <p-inputnumber
            inputId="maxTarget"
            [(ngModel)]="maxTarget"
            inputStyleClass="p-inputtext"
          />
        </div>

        <div class="flex items-center justify-between gap-2">
          <label for="miningInterval">Intervalo (s)</label>

          <p-selectbutton
            [options]="[
              { name: '0s', value: 0 },
              { name: '0.5s', value: 0.5 },
              { name: '1s', value: 1 },
              { name: '2s', value: 2 }
            ]"
            [(ngModel)]="miningInterval"
            optionLabel="name"
            optionValue="value"
          />
        </div>

        <div class="flex items-center justify-between gap-2">
          <label for="nBlocksToReadjust">Blocos para Reajuste</label>
          <p-inputnumber
            inputId="nBlocksToReadjust"
            [(ngModel)]="nBlocksToAdjust"
            inputStyleClass="p-inputtext"
          />
        </div>

        <div class="flex items-center justify-between gap-2">
          <label for="miningTimeSeconds">Tempo Médio (s)</label>
          <p-selectbutton
            [options]="[
              { name: '1s', value: 1 },
              { name: '10s', value: 10 },
              { name: '100s', value: 100 }
            ]"
            [(ngModel)]="miningTimeSeconds"
            optionLabel="name"
            optionValue="value"
          />
        </div>

        <div class="flex items-center justify-between gap-2">
          <label>Parar Automaticamente</label>
          <p-selectButton
            [options]="autoPauseModeOptions"
            [(ngModel)]="autoPauseMode"
            optionLabel="label"
            optionValue="value"
          ></p-selectButton>
        </div>
      </div>

      <ng-template #footer>
        <button
          pButton
          label="Salvar"
          icon="pi pi-check"
          class="p-button-primary"
          (click)="saveParameters()"
        ></button>
      </ng-template>
    </p-dialog>
  </div>
</p-card>
