<div class="mb-12">
  <div class="flex items-center justify-between mb-4">
    <h2 class="text-2xl font-semibold">Mineradores</h2>
    <button
      class="px-4 py-2 rounded bg-blue-600 text-white font-semibold hover:bg-blue-700 transition"
      (click)="addMiner()"
    >
      + Adicionar Minerador
    </button>
  </div>
  <div *ngIf="miners.length === 0" class="text-zinc-400 italic mb-4">
    Nenhum minerador adicionado ainda.
  </div>
  <div class="flex flex-col gap-6">
    <div
      *ngFor="let miner of miners; let i = index"
      class="bg-zinc-800 rounded-lg shadow p-6 border border-zinc-700"
    >
      <div class="flex items-center gap-2 mb-4">
        <span class="text-lg font-bold text-blue-400">{{ miner.name }}</span>
        <span class="ml-auto text-xs text-zinc-400">#{{ i + 1 }}</span>
        <button
          class="ml-2 p-1 rounded text-zinc-400 hover:text-red-400 hover:bg-zinc-700 transition"
          (click)="removeMiner(i)"
          title="Remover minerador"
        >
          <svg
            xmlns="http://www.w3.org/2000/svg"
            class="h-4 w-4"
            fill="none"
            viewBox="0 0 24 24"
            stroke="currentColor"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"
            />
          </svg>
        </button>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <div class="space-y-4">
          <div class="flex items-center gap-2">
            <span class="text-xs text-zinc-400">Hash Rate:</span>
            <div class="flex gap-1">
              <button
                *ngFor="let rate of hashRateOptions"
                class="px-2 py-1 rounded text-xs font-semibold transition"
                [ngClass]="{
                  'bg-blue-600 text-white': miner.hashRate === rate.value,
                  'bg-zinc-700 text-zinc-300 hover:bg-zinc-600':
                    miner.hashRate !== rate.value
                }"
                (click)="setHashRate(miner, rate.value)"
                [title]="rate.label"
              >
                {{ rate.label }}
              </button>
            </div>
          </div>
          <div class="flex items-center gap-2">
            <span class="text-xs text-zinc-400">Endereço:</span>
            <span class="font-mono text-xs text-green-400 break-all">{{
              miner.miningAddress
            }}</span>
          </div>
          <div class="flex items-center gap-2">
            <span class="text-xs text-zinc-400">Assinatura:</span>
            <span class="font-mono text-xs text-green-400">{{
              miner.name
            }}</span>
          </div>

          <div class="flex items-center gap-2 mt-4">
            <button
              *ngIf="!miner.isMining"
              class="px-3 py-1 rounded bg-green-600 text-white text-sm font-semibold hover:bg-green-700 transition"
              (click)="startMining(miner)"
            >
              Iniciar Mineração
            </button>
            <button
              *ngIf="miner.isMining"
              class="px-3 py-1 rounded bg-yellow-600 text-white text-sm font-semibold hover:bg-yellow-700 transition"
              (click)="stopMining(miner)"
            >
              Pausar Mineração
            </button>
            <button
              class="px-3 py-1 rounded bg-blue-600 text-white text-sm font-semibold hover:bg-blue-700 transition"
              (click)="createTransaction(miner)"
            >
              Nova Transação
            </button>
            <span
              class="ml-2 px-2 py-1 rounded text-xs"
              [ngClass]="{
                'bg-green-900 text-green-400': miner.isMining,
                'bg-zinc-900 text-zinc-400':
                  !miner.isMining && !isSyncing(miner),
                'bg-blue-900 text-blue-400 animate-pulse': isSyncing(miner)
              }"
            >
              {{
                miner.isMining
                  ? "Minerando..."
                  : isSyncing(miner)
                  ? "Sincronizando..."
                  : "Parado"
              }}
            </span>
          </div>
        </div>

        <div>
          <app-mining-block
            [block]="miner.currentBlock"
            [miningElapsed]="miner.currentBlock?.miningElapsed"
          ></app-mining-block>
        </div>
      </div>

      <!-- Blockchain Local -->
      <div class="mt-6">
        <div class="flex items-center justify-between mb-4">
          <h3 class="text-lg font-semibold text-blue-400">Blockchain Local</h3>
          <span class="text-xs text-zinc-400">
            {{ miner.getMainChain().length || 0 }} blocos
            <span *ngIf="miner.getLatestBlock()"
              >(Último: #{{ miner.getLatestBlock()?.height }})</span
            >
          </span>
        </div>
        <div class="relative">
          <div class="overflow-x-auto pb-4">
            <div class="relative min-w-max">
              @if(miner.genesis){
              <div class="flex flex-row space-x-8 items-start">
                <!-- Bloco atual -->
                <div
                  *ngFor="
                    let nodes of miner.heights.slice().reverse();
                    let height = index
                  "
                  class="relative"
                >
                  @let h = miner.heights.length - height - 1;
                  <div
                    class="relative py-2 flex flex-col space-y-4"
                    [@blockAnimation]
                  >
                    <div
                      *ngFor="let node of nodes"
                      class="bg-zinc-800 rounded-lg p-4 border border-zinc-600 w-64 shadow hover:scale-[1.03] transition-transform cursor-pointer group flex flex-col gap-1"
                    >
                      <div class="flex items-center justify-between mb-1">
                        <span
                          class="font-semibold text-blue-300 text-base flex items-center gap-2"
                        >
                          #{{ h }}
                        </span>
                        <div class="flex items-center gap-2">
                          <span class="text-xs text-zinc-400">{{
                            node.block.timestamp | date : "shortTime"
                          }}</span>
                          <span
                            *ngIf="node.block.minerId"
                            class="text-xs text-blue-400 bg-blue-900/50 rounded px-2 py-0.5"
                            >Miner {{ node.block.minerId }}</span
                          >
                        </div>
                      </div>
                      <div class="border-b border-zinc-700 my-1"></div>
                      <div class="mb-1">
                        <span class="text-zinc-400">Hash:</span>
                        <div class="font-mono text-xs text-zinc-300 break-all">
                          {{ node.block.hash }}
                        </div>
                      </div>
                      <div class="mb-1">
                        <span class="text-zinc-400">Anterior:</span>
                        <div class="font-mono text-xs text-zinc-500 break-all">
                          {{ node.block.previousHash }}
                        </div>
                      </div>
                      <div class="flex items-center justify-between mt-1">
                        <div class="flex items-center gap-1">
                          <span class="text-zinc-400">Txs:</span>
                          <span class="font-mono text-xs text-zinc-300">{{
                            node.block.transactions.length
                          }}</span>
                        </div>
                        <div class="flex items-center gap-1">
                          <span class="text-zinc-400">Nonce:</span>
                          <span class="font-mono text-xs text-zinc-300">{{
                            node.block.nonce
                          }}</span>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              }
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
